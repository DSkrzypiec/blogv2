<!DOCTYPE html><html lang="en" data-astro-cid-gvpn4u4b> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Getting method&#39;s source code in Go</title><style>*,*:before,*:after{box-sizing:border-box}html,body{max-width:100%;overflow-x:hidden}html{-webkit-text-size-adjust:100%}:root{--bg-color: #111010;--text-primary: #ffe9c6;--text-secondary: #2AA198;--accent-color: #f97d43;--font-body: "Roboto", sans-serif;--font-code: "JetBrains Mono", monospace}html{font-size:19px}@media (max-width: 480px){html{font-size:16px}}@media (max-width: 360px){html{font-size:15px}}body{font-size:1rem;line-height:1.66;background-color:var(--bg-color);color:var(--text-primary);font-family:var(--font-body);margin:0;padding:0;word-wrap:break-word;overflow-wrap:break-word}h1{font-size:2.25rem;line-height:1.2}h2{font-size:1.75rem;line-height:1.3}h3{font-size:1.35rem;line-height:1.35}@media (max-width: 768px){h1{font-size:2rem}h2{font-size:1.5rem}h3{font-size:1.2rem}}@media (max-width: 480px){h1{font-size:1.75rem}h2{font-size:1.35rem}h3{font-size:1.1rem}}@media (max-width: 360px){h1{font-size:1.6rem}h2{font-size:1.25rem}h3{font-size:1.05rem}}a{color:var(--text-secondary);text-decoration:none}a:hover{text-decoration:underline}pre{background-color:#1e1e1e;border-radius:8px;padding:1rem;overflow-x:auto;margin:1rem 0;font-size:15px;font-family:var(--font-code)}code{background-color:transparent}pre>code{display:block}.toc ul{list-style:none;margin:0;padding:0}.toc li{margin:.5rem 0}.toc a{color:var(--text-secondary);text-decoration:none}.toc a:hover{text-decoration:underline}.toc a.active{font-weight:700;color:var(--accent-color)}nav[data-astro-cid-dmqpwcec]{padding:1rem 0;text-align:center}ul[data-astro-cid-dmqpwcec]{list-style:none;padding:0;margin:0;display:flex;justify-content:center;gap:1.5rem;flex-wrap:wrap}@media (max-width: 480px){ul[data-astro-cid-dmqpwcec]{gap:1rem}a[data-astro-cid-dmqpwcec]{font-size:1rem;padding:.4rem .8rem}}@media (max-width: 360px){ul[data-astro-cid-dmqpwcec]{gap:.5rem}a[data-astro-cid-dmqpwcec]{font-size:.9rem;padding:.3rem .6rem}}li[data-astro-cid-dmqpwcec]{display:inline}a[data-astro-cid-dmqpwcec]{color:var(--text-primary);font-size:1.2rem;padding:.5rem 1rem;border:1px solid transparent;transition:all .3s ease-in-out}a[data-astro-cid-dmqpwcec]:hover{border:1px solid var(--accent-color);border-radius:4px;color:var(--accent-color)}.active[data-astro-cid-dmqpwcec] a[data-astro-cid-dmqpwcec]{color:var(--accent-color);font-weight:700;border-bottom:2px solid var(--accent-color)}hr[data-astro-cid-dmqpwcec]{margin-top:1rem;border:none;height:2px;background:var(--text-secondary);width:90%;max-width:800px;margin-left:auto;margin-right:auto}
.post-title[data-astro-cid-resui2ln]{margin-bottom:2rem}.post-title[data-astro-cid-resui2ln] h1[data-astro-cid-resui2ln]{font-size:1.75rem;color:var(--accent-color);margin:0}.post-date[data-astro-cid-resui2ln]{font-size:1rem;color:var(--text-secondary);margin-top:.5rem}.publish-label[data-astro-cid-resui2ln]{font-weight:700;color:var(--text-primary)}
.chapter[data-astro-cid-5d3zeytc]{font-size:2rem;margin-top:2rem;color:var(--accent-color)}.chapter[data-astro-cid-5d3zeytc] a[data-astro-cid-5d3zeytc]{color:var(--accent-color);text-decoration:none}.chapter[data-astro-cid-5d3zeytc] a[data-astro-cid-5d3zeytc]:hover{text-decoration:underline}
.post-layout{display:flex;flex-direction:row}@media (min-width: 1024px){.post-layout{flex-direction:row}.post-layout-sidebar{position:fixed;left:2rem;top:10rem;width:200px;font-size:.85rem;padding:1rem;z-index:10}.post-layout-content{flex:1;max-width:1000px;margin:0 auto;padding-left:240px;padding-right:2rem}}@media (min-width: 1400px){.post-layout-content{max-width:1200px}}.post-layout-sidebar{display:none}@media (min-width: 1024px){.post-layout-sidebar{display:block}}@media (max-width: 1023px){.post-layout{flex-direction:column}.post-layout-content{width:100%;max-width:100%}}main[data-astro-cid-gvpn4u4b]{padding:2rem 1rem;max-width:900px;margin:0 auto;width:100%;box-sizing:border-box}@media (min-width: 1024px){main[data-astro-cid-gvpn4u4b]{padding:2rem 0;max-width:none}}@media (max-width: 768px){main[data-astro-cid-gvpn4u4b]{padding:1.5rem .75rem}}@media (max-width: 480px){main[data-astro-cid-gvpn4u4b]{padding:1rem .5rem}}article[data-astro-cid-gvpn4u4b]{max-width:800px;width:100%;margin:0 auto;color:var(--text-primary);box-sizing:border-box;word-wrap:break-word;overflow-wrap:break-word}h1[data-astro-cid-gvpn4u4b],h2[data-astro-cid-gvpn4u4b],h3[data-astro-cid-gvpn4u4b]{color:var(--accent-color);margin-top:1.5rem;word-wrap:break-word;overflow-wrap:break-word}p[data-astro-cid-gvpn4u4b]{color:var(--text-secondary);word-wrap:break-word;overflow-wrap:break-word;hyphens:auto}img[data-astro-cid-gvpn4u4b]{max-width:100%;max-height:400px;width:auto;height:auto;border-radius:8px;margin:1rem 0;object-fit:contain}@media (max-width: 768px){img[data-astro-cid-gvpn4u4b]{max-height:300px}}@media (max-width: 480px){img[data-astro-cid-gvpn4u4b]{max-height:250px}}blockquote[data-astro-cid-gvpn4u4b]{border-left:4px solid var(--accent-color);padding-left:1rem;color:var(--text-primary);font-style:italic;margin:1rem 0}code[data-astro-cid-gvpn4u4b]{font-family:monospace;background:#ffffff1a;padding:.2rem .4rem;border-radius:4px;font-size:.95rem}
.image-container[data-astro-cid-6kov3kig]{display:flex;flex-direction:column;align-items:center;margin:1.5rem 0}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{width:auto;height:auto;border-radius:8px;object-fit:contain;box-shadow:0 4px 8px #0000001a}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig].inverted{filter:invert(1)}.image-caption[data-astro-cid-6kov3kig]{margin-top:.5rem;font-size:.9rem;color:var(--text-secondary, #666);font-style:italic;text-align:center;max-width:600px}@media (max-width: 768px){.image-container[data-astro-cid-6kov3kig]{margin:1rem 0}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{max-height:300px!important}}@media (max-width: 480px){.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{max-height:250px!important}.image-caption[data-astro-cid-6kov3kig]{font-size:.8rem;padding:0 1rem}}
</style></head> <body data-astro-cid-gvpn4u4b> <header data-astro-cid-gvpn4u4b> <nav data-astro-cid-dmqpwcec> <ul data-astro-cid-dmqpwcec> <li class data-astro-cid-dmqpwcec> <a href="/" data-astro-cid-dmqpwcec>Posts</a> </li><li class data-astro-cid-dmqpwcec> <a href="/about" data-astro-cid-dmqpwcec>About</a> </li><li class data-astro-cid-dmqpwcec> <a href="/resume" data-astro-cid-dmqpwcec>Resume</a> </li> </ul> </nav>  </header> <!-- 
      1) Wrap sidebar + main in a single parent .post-layout
         so flexbox can place them side by side on large screens 
    --> <div class="post-layout" data-astro-cid-gvpn4u4b> <!-- SIDEBAR --> <aside class="post-layout-sidebar" data-astro-cid-gvpn4u4b> <!-- The nav container that will hold our generated TOC --><nav id="table-of-contents" class="toc"></nav> <script client:load>
  window.addEventListener('DOMContentLoaded', () => {
    buildTOC();
    highlightActiveHeading();
  });

  // 1. Build the TOC once the page is loaded
  function buildTOC() {
    const chapterHeadings = Array.from(document.querySelectorAll('h2.chapter[id]'));
    const tocContainer = document.getElementById('table-of-contents');
    if (!tocContainer) return;

    const ul = document.createElement('ul');

    chapterHeadings.forEach((heading) => {
      const li = document.createElement('li');
      const a = document.createElement('a');

      // The heading has an `id` like "intro" or "symptoms"
      a.href = `#${heading.id}`;

      a.textContent = heading.textContent.trim();

      li.appendChild(a);
      ul.appendChild(li);
    });

    tocContainer.appendChild(ul);
  }

    function highlightActiveHeading() {
      const links = Array.from(document.querySelectorAll('#table-of-contents a'));
      const headingEls = links.map((link) => document.getElementById(link.hash.slice(1)));

      // 3. Create the observer
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            console.log(
              `Heading: ${entry.target.id}, isIntersecting: ${entry.isIntersecting}`
            );
            if (entry.isIntersecting) {
              // Remove 'active' from all links
              links.forEach((l) => l.classList.remove('active'));

              // Highlight the link for the heading that just entered
              const activeLink = links.find(
                (l) => l.hash === `#${entry.target.id}`
              );
              if (activeLink) {
                activeLink.classList.add('active');
              }
            }
          });
        },
        {
          root: null,
          rootMargin: '-15% 0px -60% 0px',
          threshold: 0,
        }
      );

      // 4. Observe each heading
      headingEls.forEach((el) => {
        if (el) {
          console.log(`Observing heading: ${el.id}`);
          observer.observe(el);
        }
      });
    }
</script> </aside> <!-- MAIN CONTENT AREA --> <div class="post-layout-content" data-astro-cid-gvpn4u4b> <main data-astro-cid-gvpn4u4b> <article data-astro-cid-gvpn4u4b>  <div class="post-title" data-astro-cid-resui2ln> <h1 data-astro-cid-resui2ln>Getting method&#39;s source code in Go</h1> <p class="post-date" data-astro-cid-resui2ln> <span class="publish-label" data-astro-cid-resui2ln>Publish date:</span> 2023-08-21 </p> </div>  <div class="image-container" data-astro-cid-6kov3kig> <img src="/go-ast/top.png" alt="Go AST metaprogramming" style="max-width: 100%; max-height: 400px;" class data-astro-cid-6kov3kig> <p class="image-caption" data-astro-cid-6kov3kig>Go AST metaprogramming - getting method source code at runtime</p> </div>  <h2 id="intro" class="chapter" data-astro-cid-5d3zeytc> <a href="#intro" data-astro-cid-5d3zeytc>Intro</a> </h2>  <p>
Recently I thought I want to have a function, implemented in Go, which would return method's source code for given type
    and method name in the runtime. Something of this signature:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#569CD6">func</span><span style="color:#DCDCAA"> MethodBodySource</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">typeName</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">methodName</span><span style="color:#4EC9B0"> string</span><span style="color:#D4D4D4">) (*</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">BlockStmt</span><span style="color:#D4D4D4">, </span><span style="color:#4EC9B0">string</span><span style="color:#D4D4D4">, </span><span style="color:#4EC9B0">error</span><span style="color:#D4D4D4">) {</span></span>
<span class="line"><span style="color:#6A9955">    // implementation here</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <p>
This function would return found function body <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a> (which in Go is
    block statement), it's source code as string and possibly an error.
</p> <p>
In dynamically typed and interpreted languages this is a foundation functionality.
    For example, in Python, it's enough to do the following:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C586C0">import</span><span style="color:#D4D4D4"> inspect</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6">def</span><span style="color:#DCDCAA"> func_source</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">f</span><span style="color:#D4D4D4">) -> </span><span style="color:#4EC9B0">str</span><span style="color:#D4D4D4">:</span></span>
<span class="line"><span style="color:#C586C0">    return</span><span style="color:#D4D4D4"> inspect.getsource(f)</span></span></code></pre> <p>
In compiled languages this looks usually a bit more complicated and involves some kind of metaprogramming. I want to
    have this function to detect whenever specific kind of methods in my project has been changed, to denote it in the
    database (external persistent place for data really). I thought I would get the answer to my problem in an hour at
    most using Stackoverflow, ChatGPT and Google. I was wrong. It took me a bit more. In the end the answer is not really
    complicated but getting there took me few moments. Thus I thought it might be a good idea to summarize it in a blog
    post.
</p> <p>
On metaprogramming in Go there are several kinds available. Code generation via <code>go generate</code>, <a href="https://en.wikipedia.org/wiki/Reflective_programming">reflective
    programming</a> via standard <code>reflect</code> package and manipulation of
    Go abstract syntax tree (AST) using <code>go/token</code>, <code>go/scanner</code>, <code>go/parser</code> and <code>go/ast</code> standard packages. For my
    problem reflection and getting use of the AST sounds like perfect match. Usually I don't need to reach for
    metaprogramming, so in case of this problem I thought it's a good occasion to explore those a bit deeper.
</p> <h2 id="high-level-approach" class="chapter" data-astro-cid-5d3zeytc> <a href="#high-level-approach" data-astro-cid-5d3zeytc>High level approach</a> </h2>  <p>
High level plan for implementing this function is really simple.
</p> <ol> <li>Get AST or set of ASTs for the project source code</li> <li>Implement AST traversal for finding the right method (`*ast.FuncDecl`)</li> <li>Return `*ast.FuncDecl.Body` (`*ast.BlockStmt`) and its serialization to a string</li> </ol> <h2 id="parsing-ast" class="chapter" data-astro-cid-5d3zeytc> <a href="#parsing-ast" data-astro-cid-5d3zeytc>Parsing AST of the project</a> </h2>  <p>
Initially I thought I could simply use <code>go/parser</code> package to easily parse the whole Go project and I would get a
    single big AST to work on. It turned out this package only supports <a href="https://pkg.go.dev/go/parser#ParseFile">parser.ParseFile</a>
and <a href="https://pkg.go.dev/go/parser#ParseDir">parser.ParseDir</a> functionalities for parsing single file or single
    directory of files. At this point I thought I don't really know how Go exactly do the compilation.
</p> <p>
As I learned ASTs are parsed for every Go file separately and basic unit is a Go package. That makes sense, because for
    example methods for a single type might be scattered across many files within the package. But still on the package
    level Go keeps a list of `*ast.File` ASTs rather then combining them into a single tree. Then type checking is also done
    upon slice of ASTs.
</p> <p>
Instead of manually parsing all `*.go` files I thought, perhaps, I could use already existing functionality which is
    used by the compiler itself. I found <a href="https://pkg.go.dev/golang.org/x/tools@v0.12.0/go/packages">golang.org/x/tools/go/packages</a>
package. As documentation states <em>Package packages loads Go packages for inspection and analysis</em>. In particular it
    contains <a href="https://pkg.go.dev/golang.org/x/tools@v0.12.0/go/packages#Load">packages.Load</a> function which loads packages
    according to given configuration and returns slice of pointers to Package:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#569CD6">type</span><span style="color:#4EC9B0"> Package</span><span style="color:#569CD6"> struct</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">    ID</span><span style="color:#4EC9B0"> string</span></span>
<span class="line"><span style="color:#9CDCFE">    PkgPath</span><span style="color:#4EC9B0"> string</span></span>
<span class="line"><span style="color:#9CDCFE">    Errors</span><span style="color:#D4D4D4"> []</span><span style="color:#4EC9B0">Error</span></span>
<span class="line"><span style="color:#9CDCFE">    TypeErrors</span><span style="color:#D4D4D4"> []</span><span style="color:#4EC9B0">types</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Error</span></span>
<span class="line"><span style="color:#9CDCFE">    GoFiles</span><span style="color:#D4D4D4"> []</span><span style="color:#4EC9B0">string</span></span>
<span class="line"><span style="color:#6A9955">    // other fields...</span></span>
<span class="line"><span style="color:#9CDCFE">    Types</span><span style="color:#D4D4D4"> *</span><span style="color:#4EC9B0">types</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Package</span></span>
<span class="line"><span style="color:#9CDCFE">    Fset</span><span style="color:#D4D4D4"> *</span><span style="color:#4EC9B0">token</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">FileSet</span></span>
<span class="line"><span style="color:#9CDCFE">    Syntax</span><span style="color:#D4D4D4"> []*</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">File</span></span>
<span class="line"><span style="color:#6A9955">    // other fields...</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <p>
As we can see it contains `Syntax` field which is a slice of ASTs of all `*.go` files in the package. To load all
    packages in the current Go module (project) we can use a function similar to the following:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#569CD6">func</span><span style="color:#DCDCAA"> projectPackages</span><span style="color:#D4D4D4">() []*</span><span style="color:#4EC9B0">packages</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Package</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">    cfg</span><span style="color:#D4D4D4"> := &#x26;</span><span style="color:#4EC9B0">packages</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Config</span><span style="color:#D4D4D4">{</span></span>
<span class="line"><span style="color:#9CDCFE">        Mode</span><span style="color:#D4D4D4">:  </span><span style="color:#9CDCFE">packages</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">NeedFiles</span><span style="color:#D4D4D4"> | </span><span style="color:#9CDCFE">packages</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">NeedSyntax</span><span style="color:#D4D4D4"> | </span><span style="color:#9CDCFE">packages</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">NeedTypes</span><span style="color:#D4D4D4">,</span></span>
<span class="line"><span style="color:#9CDCFE">        Tests</span><span style="color:#D4D4D4">: </span><span style="color:#569CD6">false</span><span style="color:#D4D4D4">,</span></span>
<span class="line"><span style="color:#D4D4D4">    }</span></span>
<span class="line"><span style="color:#9CDCFE">    pkgs</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">err</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">packages</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Load</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">cfg</span><span style="color:#D4D4D4">, </span><span style="color:#CE9178">"./..."</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#C586C0">    if</span><span style="color:#9CDCFE"> err</span><span style="color:#D4D4D4"> != </span><span style="color:#569CD6">nil</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">        log</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Panic</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">err</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#D4D4D4">    }</span></span>
<span class="line"><span style="color:#C586C0">    return</span><span style="color:#9CDCFE"> pkgs</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <p>
The crucial configuration in here is adding <code>packages.NeedSyntax</code> to the <code>Mode</code>. Otherwise ASTs will not be parsed. Ok,
    so at this point we have a slice of ASTs for our project. There are few minor caveats, but we'll come back to it a bit
    later. Using <code>ast.Print</code> function we can print a AST in a pretty format:
</p> <div class="image-container" data-astro-cid-6kov3kig> <img src="/go-ast/ast.png" alt="Go AST example output" style="max-width: 100%; max-height: 400px;" class data-astro-cid-6kov3kig> <p class="image-caption" data-astro-cid-6kov3kig>Example output of ast.Print showing the structure of a Go AST</p> </div>  <p>
Just for an illustrative example, if you would like to print ASTs for all parsed files, you can do something like that:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#9CDCFE">pkgs</span><span style="color:#D4D4D4"> := </span><span style="color:#DCDCAA">projectPackages</span><span style="color:#D4D4D4">()</span></span>
<span class="line"><span style="color:#C586C0">for</span><span style="color:#9CDCFE"> _</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">pkg</span><span style="color:#D4D4D4"> := </span><span style="color:#C586C0">range</span><span style="color:#9CDCFE"> pkgs</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#C586C0">    for</span><span style="color:#9CDCFE"> idx</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">astFile</span><span style="color:#D4D4D4"> := </span><span style="color:#C586C0">range</span><span style="color:#9CDCFE"> pkg</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Syntax</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">        fmt</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Printf</span><span style="color:#D4D4D4">(</span><span style="color:#CE9178">"Pkg: </span><span style="color:#9CDCFE">%s</span><span style="color:#CE9178"> | File: </span><span style="color:#9CDCFE">%s</span></span>
<span class="line"><span style="color:#CE9178">"</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">pkg</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">pkg</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">GoFiles</span><span style="color:#D4D4D4">[</span><span style="color:#9CDCFE">idx</span><span style="color:#D4D4D4">])</span></span>
<span class="line"><span style="color:#9CDCFE">        ast</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Print</span><span style="color:#D4D4D4">(</span><span style="color:#569CD6">nil</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">astFile</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#D4D4D4">    }</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <h2 id="finding-method" class="chapter" data-astro-cid-5d3zeytc> <a href="#finding-method" data-astro-cid-5d3zeytc>Finding the right method in the AST</a> </h2>  <p>
Once we have AST, finding the right sub-tree for given method and type name is rather straightforward. Especially in
    case when we can just implement few examples and print its ASTs, to get familiar with types used in Go AST. Possible
    implementation can look like the following:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#569CD6">func</span><span style="color:#DCDCAA"> findMethodInAST</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">astFile</span><span style="color:#D4D4D4"> *</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">File</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">typeName</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">methodName</span><span style="color:#4EC9B0"> string</span><span style="color:#D4D4D4">) *</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">FuncDecl</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#C586C0">    for</span><span style="color:#9CDCFE"> _</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">decl</span><span style="color:#D4D4D4"> := </span><span style="color:#C586C0">range</span><span style="color:#9CDCFE"> astFile</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Decls</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">        funcDecl</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">isFunc</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">decl</span><span style="color:#D4D4D4">.(*</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">FuncDecl</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#C586C0">        if</span><span style="color:#D4D4D4"> !</span><span style="color:#9CDCFE">isFunc</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#C586C0">            continue</span></span>
<span class="line"><span style="color:#D4D4D4">        }</span></span>
<span class="line"><span style="color:#C586C0">        if</span><span style="color:#9CDCFE"> funcDecl</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Recv</span><span style="color:#D4D4D4"> == </span><span style="color:#569CD6">nil</span><span style="color:#D4D4D4"> || </span><span style="color:#DCDCAA">len</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">funcDecl</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Recv</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">List</span><span style="color:#D4D4D4">) != </span><span style="color:#B5CEA8">1</span><span style="color:#D4D4D4"> || </span><span style="color:#9CDCFE">funcDecl</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Name</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Name</span><span style="color:#D4D4D4"> != </span><span style="color:#9CDCFE">methodName</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#C586C0">            continue</span></span>
<span class="line"><span style="color:#D4D4D4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9CDCFE">        ident</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">isIdent</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">funcDecl</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Recv</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">List</span><span style="color:#D4D4D4">[</span><span style="color:#B5CEA8">0</span><span style="color:#D4D4D4">].</span><span style="color:#9CDCFE">Type</span><span style="color:#D4D4D4">.(*</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Ident</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#C586C0">        if</span><span style="color:#9CDCFE"> isIdent</span><span style="color:#D4D4D4"> &#x26;&#x26; </span><span style="color:#9CDCFE">ident</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Name</span><span style="color:#D4D4D4"> == </span><span style="color:#9CDCFE">typeName</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#C586C0">            return</span><span style="color:#9CDCFE"> funcDecl</span></span>
<span class="line"><span style="color:#D4D4D4">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955">        // Check for *T receivers</span></span>
<span class="line"><span style="color:#9CDCFE">        starExpr</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">isStar</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">funcDecl</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Recv</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">List</span><span style="color:#D4D4D4">[</span><span style="color:#B5CEA8">0</span><span style="color:#D4D4D4">].</span><span style="color:#9CDCFE">Type</span><span style="color:#D4D4D4">.(*</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">StarExpr</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#C586C0">        if</span><span style="color:#9CDCFE"> isStar</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">            ident</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">isIdent</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">starExpr</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">X</span><span style="color:#D4D4D4">.(*</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Ident</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#C586C0">            if</span><span style="color:#9CDCFE"> isIdent</span><span style="color:#D4D4D4"> &#x26;&#x26; </span><span style="color:#9CDCFE">ident</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Name</span><span style="color:#D4D4D4"> == </span><span style="color:#9CDCFE">typeName</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#C586C0">                return</span><span style="color:#9CDCFE"> funcDecl</span></span>
<span class="line"><span style="color:#D4D4D4">            }</span></span>
<span class="line"><span style="color:#D4D4D4">        }</span></span>
<span class="line"><span style="color:#D4D4D4">    }</span></span>
<span class="line"><span style="color:#C586C0">    return</span><span style="color:#569CD6"> nil</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <p>
A bit of explanations
</p> <ol> <li>Iterate over all declarations in AST (`*ast.File`)</li> <li>Check whenever this declaration is a function declaration, if not continue to the next one</li> <li>Check whenever this function has appropriate name and declaration has a receiver, to make sure it's a method and not free function</li> <li>At this point we have two cases. Method can be defined on type `T` or pointer `*T`</li> <li>In the first case we check if receiver type is an identifier (`*ast.Ident`) and then check it's name</li> <li>In the other case we check for `*ast.StarExpr` and then take identifier from `*ast.StarExpr.X`</li> <li>If any of those two cases type name matches given type name, we know we found the right sub-tree and can return `*ast.FuncDecl`</li> </ol> <p>
Overall, in my problem, we can assume that whole Go project was successfully compiled. In particular we can assume that
    within single package pairs of types and methods and unique, thus we can return the first matching method in the AST is
    the only one.
</p> <h2 id="ast-serialization" class="chapter" data-astro-cid-5d3zeytc> <a href="#ast-serialization" data-astro-cid-5d3zeytc>AST to string serialization</a> </h2>  <p>
As we would expect for AST serialization there is already implemented function in the standard library -
<a href="https://pkg.go.dev/go/printer#Fprint">printer.Fprint</a> from <code>go/printer</code> standard package:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#569CD6">func</span><span style="color:#DCDCAA"> Fprint</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">output</span><span style="color:#4EC9B0"> io</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Writer</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">fset</span><span style="color:#D4D4D4"> *</span><span style="color:#4EC9B0">token</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">FileSet</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">node</span><span style="color:#4EC9B0"> any</span><span style="color:#D4D4D4">) </span><span style="color:#4EC9B0">error</span></span></code></pre> <p>
Argument `node` is any node of the AST. As we can see this function requires `*token.FileSet` which is an object that
    keeps a slice of source files (`*token.File`). That's basically because `printer.Fprint` does not serialize AST just
    based on its content but rather uses token positions from AST to read it from `*token.FileSet`. I'm guessing it's
    mainly because to have mapping of AST nodes to concert file in the file system and lines in that file. Those are in
    particular included in stack traces.
</p> <p>
In case of parsing ASTs using mentioned `packages.Load` function there is single `*token.FileSet` per package which is
    stored in `packages.Package.Fset` field. Knowing that we can go ahead and serialize AST of body of our target method
    back into a string.
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#9CDCFE">pkgs</span><span style="color:#D4D4D4"> := </span><span style="color:#DCDCAA">projectPackages</span><span style="color:#D4D4D4">()</span></span>
<span class="line"><span style="color:#C586C0">for</span><span style="color:#9CDCFE"> _</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">pkg</span><span style="color:#D4D4D4"> := </span><span style="color:#C586C0">range</span><span style="color:#9CDCFE"> pkgs</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#C586C0">    for</span><span style="color:#9CDCFE"> idx</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">astFile</span><span style="color:#D4D4D4"> := </span><span style="color:#C586C0">range</span><span style="color:#9CDCFE"> pkg</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Syntax</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">        helloMethod</span><span style="color:#D4D4D4"> := </span><span style="color:#DCDCAA">findMethodInAST</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">astFile</span><span style="color:#D4D4D4">, </span><span style="color:#CE9178">"A"</span><span style="color:#D4D4D4">, </span><span style="color:#CE9178">"Hello"</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#C586C0">        if</span><span style="color:#9CDCFE"> helloMethod</span><span style="color:#D4D4D4"> != </span><span style="color:#569CD6">nil</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#569CD6">            var</span><span style="color:#9CDCFE"> buf</span><span style="color:#4EC9B0"> bytes</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Buffer</span></span>
<span class="line"><span style="color:#9CDCFE">            printer</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Fprint</span><span style="color:#D4D4D4">(&#x26;</span><span style="color:#9CDCFE">buf</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">pkg</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Fset</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">helloMethod</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Body</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#9CDCFE">            fmt</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Println</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">buf</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">String</span><span style="color:#D4D4D4">())</span></span>
<span class="line"><span style="color:#D4D4D4">        }</span></span>
<span class="line"><span style="color:#D4D4D4">    }</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <p>
By default `printer.Fprint` prints tabs with width of 8 spaces. If you want to change it, you can do it like this
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#9CDCFE">printerCfg</span><span style="color:#D4D4D4"> := </span><span style="color:#4EC9B0">printer</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Config</span><span style="color:#D4D4D4">{</span><span style="color:#9CDCFE">Tabwidth</span><span style="color:#D4D4D4">: </span><span style="color:#B5CEA8">4</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">Mode</span><span style="color:#D4D4D4">: </span><span style="color:#9CDCFE">printer</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">UseSpaces</span><span style="color:#D4D4D4">}</span></span>
<span class="line"><span style="color:#9CDCFE">printerCfg</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Fprint</span><span style="color:#D4D4D4">(&#x26;</span><span style="color:#9CDCFE">buf</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">pkg</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Fset</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">helloMethod</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Body</span><span style="color:#D4D4D4">)</span></span></code></pre> <h2 id="is-it-done" class="chapter" data-astro-cid-5d3zeytc> <a href="#is-it-done" data-astro-cid-5d3zeytc>Is it done?</a> </h2>  <p>
It sounds like we implemented our sketched high level plan and in fact parsed all Go files in the project, found the
    right method in the AST using reflection and finally serialize it to a string. If you want to easily run the full
    example, you can pull it <a href="https://github.com/DSkrzypiec/blogSourceCodes/tree/master/20230820_GoAstMethodSource">from here</a>.
</p> <p>
It was a good start, but as I mentioned earlier there is one downside of using <code>packages.Load</code>. That is it only uses
    actual file system to load go files. It's configured by
<a href="https://pkg.go.dev/golang.org/x/tools@v0.12.0/go/packages#Config">packages.Config.Dir</a> field. Additionally we can pass
    patterns for Go file names matches in <code>packages.Load</code> function, but both settings are referring to files in the file
    system. That means if I wanted to deploy my program which uses this functionally in the Docker container or remote
    server I would need to also include project's source files. I don't like it at all! I'd say it's not acceptable for me.
    Especially in Go where we end up with single statically linked binary. It was a good exercise to fool around with ASTs
    and reflection, but can we improve the situation?
</p> <p>
I think we have two possibilities. One is to either fork and modify <code>packages</code> package and try to extend it to also
    accepts abstract file systems (like <code>embed.FS</code>) or to try starting a discussion on adding this functionality to the
    package and then starting working on the PR. The second approach would be to abandon <code>packages</code> package and implement
    simpler version - we just need to parse ASTs, based on embedded Go files in the binary. Considering amount of work of
    the first approach and my specialized use case I decided to go with the latter.
</p> <h2 id="embed-go-files" class="chapter" data-astro-cid-5d3zeytc> <a href="#embed-go-files" data-astro-cid-5d3zeytc>Embed Go files in the binary</a> </h2>  <p>
In Go 1.16 <a href="https://pkg.go.dev/embed">package embed</a> was added to Go standard library. It enables embedding files into
    program target binary. Using this embedding all wanted go files from the project into the binary is as easy as this
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#6A9955">//go:embed *.go tst/*.go tst2/*.go</span></span>
<span class="line"><span style="color:#569CD6">var</span><span style="color:#9CDCFE"> goSourceFiles</span><span style="color:#4EC9B0"> embed</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">FS</span></span></code></pre> <p>
There is no support for <code>./...</code> in <code>go:embed</code>. But that's not really a problem, because we know even before compilation
    which catalogs from the project we want to include in the target binary, so we can list them manually. That was the
    easy part. A bit more challenging would be adjusting <code>packages</code> package to use in-memory file system. Fortunately for
    my problem we don't really need it. Mentioned package does much more then just parsing package's file ASTs. It also
    perform type checks, let you choose which information about the package and files you want to load and much more. In my
    case perhaps, it's enough to embed source files and use standard <code>go/ast</code>, <code>go/token</code> and <code>go/parser</code> packages? I think
    so. I won't put whole implementation of this approach in here, but just an example how to mimic <code>packages.Load</code>
function regarding parsing ASTs for given packages based on embedded <code>goSourceFiles</code> and <code>tst</code> package.
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#569CD6">type</span><span style="color:#4EC9B0"> PackageSimple</span><span style="color:#569CD6"> struct</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">    Fset</span><span style="color:#D4D4D4">       *</span><span style="color:#4EC9B0">token</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">FileSet</span></span>
<span class="line"><span style="color:#9CDCFE">    FileToASTs</span><span style="color:#569CD6"> map</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">string</span><span style="color:#D4D4D4">]*</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">File</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6">func</span><span style="color:#DCDCAA"> tstPackageEmbedded</span><span style="color:#D4D4D4">() (</span><span style="color:#4EC9B0">PackageSimple</span><span style="color:#D4D4D4">, </span><span style="color:#4EC9B0">error</span><span style="color:#D4D4D4">) {</span></span>
<span class="line"><span style="color:#9CDCFE">    fset</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">token</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">NewFileSet</span><span style="color:#D4D4D4">()</span></span>
<span class="line"><span style="color:#9CDCFE">    fileASTs</span><span style="color:#D4D4D4"> := </span><span style="color:#DCDCAA">make</span><span style="color:#D4D4D4">(</span><span style="color:#569CD6">map</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">string</span><span style="color:#D4D4D4">]*</span><span style="color:#4EC9B0">ast</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">File</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#9CDCFE">    entries</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">_</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">goSourceFiles</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">ReadDir</span><span style="color:#D4D4D4">(</span><span style="color:#CE9178">"tst"</span><span style="color:#D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0">    for</span><span style="color:#9CDCFE"> _</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">entry</span><span style="color:#D4D4D4"> := </span><span style="color:#C586C0">range</span><span style="color:#9CDCFE"> entries</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">        fullName</span><span style="color:#D4D4D4"> := </span><span style="color:#CE9178">"tst/"</span><span style="color:#D4D4D4"> + </span><span style="color:#9CDCFE">entry</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Name</span><span style="color:#D4D4D4">()</span></span>
<span class="line"><span style="color:#9CDCFE">        data</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">_</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">goSourceFiles</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">ReadFile</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">fullName</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#9CDCFE">        astFile</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">err</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">parser</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">ParseFile</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">fset</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">entry</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Name</span><span style="color:#D4D4D4">(), </span><span style="color:#9CDCFE">data</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">parser</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">AllErrors</span><span style="color:#D4D4D4"> | </span><span style="color:#9CDCFE">parser</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">ParseComments</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#C586C0">        if</span><span style="color:#9CDCFE"> err</span><span style="color:#D4D4D4"> != </span><span style="color:#569CD6">nil</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#C586C0">            return</span><span style="color:#D4D4D4"> {}, </span><span style="color:#9CDCFE">err</span></span>
<span class="line"><span style="color:#D4D4D4">        }</span></span>
<span class="line"><span style="color:#C586C0">        if</span><span style="color:#9CDCFE"> astFile</span><span style="color:#D4D4D4"> != </span><span style="color:#569CD6">nil</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">            fileASTs</span><span style="color:#D4D4D4">[</span><span style="color:#9CDCFE">fullName</span><span style="color:#D4D4D4">] = </span><span style="color:#9CDCFE">astFile</span></span>
<span class="line"><span style="color:#D4D4D4">        }</span></span>
<span class="line"><span style="color:#D4D4D4">    }</span></span>
<span class="line"><span style="color:#C586C0">    return</span><span style="color:#4EC9B0"> PackageSimple</span><span style="color:#D4D4D4">{</span><span style="color:#9CDCFE">Fset</span><span style="color:#D4D4D4">: </span><span style="color:#9CDCFE">fset</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">FileToASTs</span><span style="color:#D4D4D4">: </span><span style="color:#9CDCFE">fileASTs</span><span style="color:#D4D4D4">}, </span><span style="color:#569CD6">nil</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <h2 id="summary" class="chapter" data-astro-cid-5d3zeytc> <a href="#summary" data-astro-cid-5d3zeytc>Summary</a> </h2>  <p>
This exercise turned out to be even more fun than I expected! I learned about initial Go compilation phases (lexing,
    parsing, type checking), a bit more about reflection and got deeper insights on Go AST. I'm glad that I solved my problem
    of getting method's source code in the runtime. I think that this hands-on experience with Go AST might become handy in
    the future.
</p> <h2 id="references" class="chapter" data-astro-cid-5d3zeytc> <a href="#references" data-astro-cid-5d3zeytc>References</a> </h2>  <ol> <li><a href="https://github.com/DSkrzypiec/blogSourceCodes/tree/master/20230820_GoAstMethodSource">Go project with full example</a></li> <li><a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST</a></li> <li><a href="https://pkg.go.dev/golang.org/x/tools@v0.12.0/go/packages">golang.org/x/tools/go/packages</a></li> </ol>  </article> </main> </div> </div>  <!-- Global styles for .post-layout and .post-layout-sidebar -->  </body></html>