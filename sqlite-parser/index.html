<!DOCTYPE html><html lang="en" data-astro-cid-gvpn4u4b> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Implementing SQLite parser in Scala</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.26/dist/katex.min.css" crossorigin="anonymous"><style>*,*:before,*:after{box-sizing:border-box}html,body{max-width:100%;overflow-x:hidden}html{-webkit-text-size-adjust:100%}:root{--bg-color: #111010;--text-primary: #ffe9c6;--text-secondary: #2AA198;--accent-color: #f97d43;--font-body: "Roboto", sans-serif;--font-code: "JetBrains Mono", monospace}html{font-size:19px}@media (max-width: 480px){html{font-size:16px}}@media (max-width: 360px){html{font-size:15px}}body{font-size:1rem;line-height:1.66;background-color:var(--bg-color);color:var(--text-primary);font-family:var(--font-body);margin:0;padding:0;word-wrap:break-word;overflow-wrap:break-word}h1{font-size:2.25rem;line-height:1.2}h2{font-size:1.75rem;line-height:1.3}h3{font-size:1.35rem;line-height:1.35}@media (max-width: 768px){h1{font-size:2rem}h2{font-size:1.5rem}h3{font-size:1.2rem}}@media (max-width: 480px){h1{font-size:1.75rem}h2{font-size:1.35rem}h3{font-size:1.1rem}}@media (max-width: 360px){h1{font-size:1.6rem}h2{font-size:1.25rem}h3{font-size:1.05rem}}a{color:var(--text-secondary);text-decoration:none}a:hover{text-decoration:underline}pre{background-color:#1e1e1e;border-radius:8px;padding:1rem;overflow-x:auto;margin:1rem 0;font-size:15px;font-family:var(--font-code)}code{background-color:transparent}pre>code{display:block}.toc ul{list-style:none;margin:0;padding:0}.toc li{margin:.5rem 0}.toc a{color:var(--text-secondary);text-decoration:none}.toc a:hover{text-decoration:underline}.toc a.active{font-weight:700;color:var(--accent-color)}nav[data-astro-cid-dmqpwcec]{padding:1rem 0;text-align:center}ul[data-astro-cid-dmqpwcec]{list-style:none;padding:0;margin:0;display:flex;justify-content:center;gap:1.5rem;flex-wrap:wrap}@media (max-width: 480px){ul[data-astro-cid-dmqpwcec]{gap:1rem}a[data-astro-cid-dmqpwcec]{font-size:1rem;padding:.4rem .8rem}}@media (max-width: 360px){ul[data-astro-cid-dmqpwcec]{gap:.5rem}a[data-astro-cid-dmqpwcec]{font-size:.9rem;padding:.3rem .6rem}}li[data-astro-cid-dmqpwcec]{display:inline}a[data-astro-cid-dmqpwcec]{color:var(--text-primary);font-size:1.2rem;padding:.5rem 1rem;border:1px solid transparent;transition:all .3s ease-in-out}a[data-astro-cid-dmqpwcec]:hover{border:1px solid var(--accent-color);border-radius:4px;color:var(--accent-color)}.active[data-astro-cid-dmqpwcec] a[data-astro-cid-dmqpwcec]{color:var(--accent-color);font-weight:700;border-bottom:2px solid var(--accent-color)}hr[data-astro-cid-dmqpwcec]{margin-top:1rem;border:none;height:2px;background:var(--text-secondary);width:90%;max-width:800px;margin-left:auto;margin-right:auto}
.post-title[data-astro-cid-resui2ln]{margin-bottom:2rem}.post-title[data-astro-cid-resui2ln] h1[data-astro-cid-resui2ln]{font-size:1.75rem;color:var(--accent-color);margin:0}.post-date[data-astro-cid-resui2ln]{font-size:1rem;color:var(--text-secondary);margin-top:.5rem}.publish-label[data-astro-cid-resui2ln]{font-weight:700;color:var(--text-primary)}
.chapter[data-astro-cid-5d3zeytc]{font-size:2rem;margin-top:2rem;color:var(--accent-color)}.chapter[data-astro-cid-5d3zeytc] a[data-astro-cid-5d3zeytc]{color:var(--accent-color);text-decoration:none}.chapter[data-astro-cid-5d3zeytc] a[data-astro-cid-5d3zeytc]:hover{text-decoration:underline}
.post-layout{display:flex;flex-direction:row}@media (min-width: 1024px){.post-layout{flex-direction:row}.post-layout-sidebar{position:fixed;left:2rem;top:10rem;width:200px;font-size:.85rem;padding:1rem;z-index:10}.post-layout-content{flex:1;max-width:1000px;margin:0 auto;padding-left:240px;padding-right:2rem}}@media (min-width: 1400px){.post-layout-content{max-width:1200px}}.post-layout-sidebar{display:none}@media (min-width: 1024px){.post-layout-sidebar{display:block}}@media (max-width: 1023px){.post-layout{flex-direction:column}.post-layout-content{width:100%;max-width:100%}}:global(pre){width:100%!important;max-width:100%!important;overflow-x:auto;box-sizing:border-box}:global(.astro-code){width:100%!important;max-width:100%!important;box-sizing:border-box}:global(.astro-code pre){width:100%!important;max-width:100%!important;overflow-x:auto;box-sizing:border-box}:global(.post-layout-content pre){max-width:100%!important;overflow-x:auto;word-wrap:break-word;white-space:pre-wrap}main[data-astro-cid-gvpn4u4b]{padding:2rem 1rem;max-width:900px;margin:0 auto;width:100%;box-sizing:border-box}@media (min-width: 1024px){main[data-astro-cid-gvpn4u4b]{padding:2rem 0;max-width:none}}@media (max-width: 768px){main[data-astro-cid-gvpn4u4b]{padding:1.5rem .75rem}}@media (max-width: 480px){main[data-astro-cid-gvpn4u4b]{padding:1rem .5rem}}article[data-astro-cid-gvpn4u4b]{max-width:800px;width:100%;margin:0 auto;color:var(--text-primary);box-sizing:border-box;word-wrap:break-word;overflow-wrap:break-word}h1[data-astro-cid-gvpn4u4b],h2[data-astro-cid-gvpn4u4b],h3[data-astro-cid-gvpn4u4b]{color:var(--accent-color);margin-top:1.5rem;word-wrap:break-word;overflow-wrap:break-word}p[data-astro-cid-gvpn4u4b]{color:var(--text-secondary);word-wrap:break-word;overflow-wrap:break-word;hyphens:auto}img[data-astro-cid-gvpn4u4b]{max-width:100%;max-height:400px;width:auto;height:auto;border-radius:8px;margin:1rem 0;object-fit:contain}@media (max-width: 768px){img[data-astro-cid-gvpn4u4b]{max-height:300px}}@media (max-width: 480px){img[data-astro-cid-gvpn4u4b]{max-height:250px}}blockquote[data-astro-cid-gvpn4u4b]{border-left:4px solid var(--accent-color);padding-left:1rem;color:var(--text-primary);font-style:italic;margin:1rem 0}code[data-astro-cid-gvpn4u4b]{font-family:monospace;background:#ffffff1a;padding:.2rem .4rem;border-radius:4px;font-size:.95rem}
.image-container[data-astro-cid-6kov3kig]{display:flex;flex-direction:column;align-items:center;margin:1.5rem 0}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{width:auto;height:auto;border-radius:8px;object-fit:contain;box-shadow:0 4px 8px #0000001a}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig].inverted{filter:invert(1)}.image-caption[data-astro-cid-6kov3kig]{margin-top:.5rem;font-size:.9rem;color:var(--text-secondary, #666);font-style:italic;text-align:center;max-width:600px}@media (max-width: 768px){.image-container[data-astro-cid-6kov3kig]{margin:1rem 0}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{max-height:300px!important}}@media (max-width: 480px){.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{max-height:250px!important}.image-caption[data-astro-cid-6kov3kig]{font-size:.8rem;padding:0 1rem}}
</style></head> <body data-astro-cid-gvpn4u4b> <header data-astro-cid-gvpn4u4b> <nav data-astro-cid-dmqpwcec> <ul data-astro-cid-dmqpwcec> <li class data-astro-cid-dmqpwcec> <a href="/" data-astro-cid-dmqpwcec>Posts</a> </li><li class data-astro-cid-dmqpwcec> <a href="/about" data-astro-cid-dmqpwcec>About</a> </li><li class data-astro-cid-dmqpwcec> <a href="/resume.html" data-astro-cid-dmqpwcec>Resume</a> </li> </ul> </nav>  </header> <!-- 
      1) Wrap sidebar + main in a single parent .post-layout
         so flexbox can place them side by side on large screens 
    --> <div class="post-layout" data-astro-cid-gvpn4u4b> <!-- SIDEBAR --> <aside class="post-layout-sidebar" data-astro-cid-gvpn4u4b> <!-- The nav container that will hold our generated TOC --><nav id="table-of-contents" class="toc"></nav> <script client:load>
  window.addEventListener('DOMContentLoaded', () => {
    buildTOC();
    highlightActiveHeading();
  });

  // 1. Build the TOC once the page is loaded
  function buildTOC() {
    const chapterHeadings = Array.from(document.querySelectorAll('h2.chapter[id]'));
    const tocContainer = document.getElementById('table-of-contents');
    if (!tocContainer) return;

    const ul = document.createElement('ul');

    chapterHeadings.forEach((heading) => {
      const li = document.createElement('li');
      const a = document.createElement('a');

      // The heading has an `id` like "intro" or "symptoms"
      a.href = `#${heading.id}`;

      a.textContent = heading.textContent.trim();

      li.appendChild(a);
      ul.appendChild(li);
    });

    tocContainer.appendChild(ul);
  }

    function highlightActiveHeading() {
      const links = Array.from(document.querySelectorAll('#table-of-contents a'));
      const headingEls = links.map((link) => document.getElementById(link.hash.slice(1)));

      // 3. Create the observer
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            console.log(
              `Heading: ${entry.target.id}, isIntersecting: ${entry.isIntersecting}`
            );
            if (entry.isIntersecting) {
              // Remove 'active' from all links
              links.forEach((l) => l.classList.remove('active'));

              // Highlight the link for the heading that just entered
              const activeLink = links.find(
                (l) => l.hash === `#${entry.target.id}`
              );
              if (activeLink) {
                activeLink.classList.add('active');
              }
            }
          });
        },
        {
          root: null,
          rootMargin: '-15% 0px -60% 0px',
          threshold: 0,
        }
      );

      // 4. Observe each heading
      headingEls.forEach((el) => {
        if (el) {
          console.log(`Observing heading: ${el.id}`);
          observer.observe(el);
        }
      });
    }
</script> </aside> <!-- MAIN CONTENT AREA --> <div class="post-layout-content" data-astro-cid-gvpn4u4b> <main data-astro-cid-gvpn4u4b> <article data-astro-cid-gvpn4u4b>  <div class="post-title" data-astro-cid-resui2ln> <h1 data-astro-cid-resui2ln>Implementing SQLite parser in Scala</h1> <p class="post-date" data-astro-cid-resui2ln> <span class="publish-label" data-astro-cid-resui2ln>Publish date:</span> 2022-10-26 </p> </div>  <div class="image-container" data-astro-cid-6kov3kig> <img src="/sqlite-parser/sqliteExprTree.png" alt="SQLite expression tree" style="max-width: 100%; max-height: 400px;" class data-astro-cid-6kov3kig> <p class="image-caption" data-astro-cid-6kov3kig>SQLite expression grammar tree</p> </div>  <h2 id="intro" class="chapter" data-astro-cid-5d3zeytc> <a href="#intro" data-astro-cid-5d3zeytc>Intro</a> </h2>  <p>
About a year ago I've played a bit with <a href="https://dskrzypiec.dev/parsing-tsql">parsing T-SQL</a>. At the time I've used
    Microsoft library and ANTLR for generating lexer and parser based on predefined T-SQL grammar. Recently I've come back
    to this topic. I've implemented <a href="https://www.sqlite.org/index.html">SQLite</a> parser almost from scratch (without code
    generation).
</p> <h2 id="but-why" class="chapter" data-astro-cid-5d3zeytc> <a href="#but-why" data-astro-cid-5d3zeytc>..., but why?</a> </h2>  <p>
In general I wanted to have a SQL parser in order to build some kind of static analyzer tool for SQL and databases. One
    might ask why I just haven't taken source code from Postgres parser or SQLite? There are few reasons
</p> <ul> <li>I didn't want C (or C++) for this particular side project at the time</li> <li>I wanted to try to unify more then one SQL dialect into single project</li> <li>Going through the full parser source code would require a bit too much work for a side project</li> </ul> <p>
Another question might be why haven't I used <a href="https://dskrzypiec.dev/parsing-tsql">ANTLR</a> or another tool for
    automatically generate parser source code based on grammar definition. The main reason was that I didn't really like
    structure of the parse tree and emphasis for visitor pattern. Also I wouldn't easily work to combine few SQL dialects
    other than defining those separately.
</p> <p>
I once tried to implement a parser from scratch in Go. It was probably the best approach, but it was still a bit too
    much hassle for a side project to implement most of SQL grammar. But recently, while I was learning Scala, I found
<a href="https://github.com/com-lihaoyi/fastparse">fastparse</a> library.
</p> <h2 id="fastparse-library" class="chapter" data-astro-cid-5d3zeytc> <a href="#fastparse-library" data-astro-cid-5d3zeytc>fastparse library</a> </h2>  <p>
The fastparse library is an implementation of <a href="https://en.wikipedia.org/wiki/Parser_combinator">parser combinators</a>
functional approach of writing parsers. Till that point I didn't know about this approach of writing parsers. I
    instantly liked it. Moreover fastparse provide a set of basic parsers which are very generic, so it's easy to start
    writing parsers.
</p> <h3>Example</h3> <p>
To get a bit better feeling about fastparse library let's consider the following code snippet.
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#569CD6">def</span><span style="color:#DCDCAA"> digit</span><span style="color:#D4D4D4">[</span><span style="color:#9CDCFE">_</span><span style="color:#D4D4D4"> : </span><span style="color:#4EC9B0">P</span><span style="color:#D4D4D4">] = </span><span style="color:#4EC9B0">P</span><span style="color:#D4D4D4">(</span><span style="color:#4EC9B0">CharIn</span><span style="color:#D4D4D4">(</span><span style="color:#CE9178">"0-9"</span><span style="color:#D4D4D4">))</span></span>
<span class="line"><span style="color:#569CD6">def</span><span style="color:#DCDCAA"> dot</span><span style="color:#D4D4D4">[</span><span style="color:#9CDCFE">_</span><span style="color:#D4D4D4"> : </span><span style="color:#4EC9B0">P</span><span style="color:#D4D4D4">] = </span><span style="color:#4EC9B0">P</span><span style="color:#D4D4D4">(</span><span style="color:#CE9178">"."</span><span style="color:#D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955">// .334</span></span>
<span class="line"><span style="color:#569CD6">def</span><span style="color:#DCDCAA"> decimalFromDot</span><span style="color:#D4D4D4">[</span><span style="color:#9CDCFE">_</span><span style="color:#D4D4D4"> : </span><span style="color:#4EC9B0">P</span><span style="color:#D4D4D4">]: </span><span style="color:#4EC9B0">P</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">SqliteDoubleLit</span><span style="color:#D4D4D4">] = {</span></span>
<span class="line"><span style="color:#4EC9B0">  P</span><span style="color:#D4D4D4">(dot ~ digit.rep(</span><span style="color:#B5CEA8">1</span><span style="color:#D4D4D4">)).!.map {</span></span>
<span class="line"><span style="color:#D4D4D4">    num => </span><span style="color:#4EC9B0">SqliteDoubleLit</span><span style="color:#D4D4D4">(num.toDouble)</span></span>
<span class="line"><span style="color:#D4D4D4">  }</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <p>
There are three Scala generic functions. First two are very simple parsers. The first one - <code>digit</code> parses a single
    digit or fails. Similar <code>dot</code> parses single dot character or fails. Parser <code>decimalFromDot</code> parses decimal literals
    which start with dot, like <code>.334</code> and not <code>0.334</code>. Firstly let's notice that this parser is of type <code>SqliteDoubleLit</code>,
    so in case when parser succeeded then result will be of this type. Now let's untangle this parsers notation a bit
</p> <ol> <li>First character should be a dot - we are using <code>dot</code> parser</li> <li><code>~</code> means in fastparse "AND", so after the dot the following must occur</li> <li>at least one digit - this is expressed by <code>digit</code> parser and fastparse <code>rep</code> function which repeats given parser</li> <li>Exclamation mark <code>!</code> means that we want to <em>capture</em> result of this parsing in case of success</li> <li>Finally <code>map</code>, in case of success, maps captured text into desired <code>SqliteDoubleLit</code>.</li> </ol> <p>
So even in this very straightforward example we are combining two other simpler parsers and couple of basic operators
    and functions from fastparse library. In actual implementation I later used this parser in literal parser which parsers
    string literals, integer literals and so on. But it's very convenient to have this parser separated. It's very easy to
    unit test and to use them in other places.
</p> <p>
If you're interested and want explore more about fastparse I'd recommend official
<a href="https://com-lihaoyi.github.io/fastparse/">documentation</a>.
</p> <h2 id="sqlite-expression" class="chapter" data-astro-cid-5d3zeytc> <a href="#sqlite-expression" data-astro-cid-5d3zeytc>SQLite expression</a> </h2>  <p>
At this point we're prepared to implement a SQL parser in Scala using fastparse library. We've got tools. Now the main
    question is where to even start? My first thought was around <code>SELECT</code> statement but I quickly realized that it require
    many parts to be already parsed. The second one was to start from a leaf of the parse tree. But which one? As I was
    browsing through SQLite grammar I realized that almost everywhere occurs an expression <code>expr</code>. Column might be defined
    as expression, in <code>JOIN</code> constrains we got expression, in <code>WHERE</code> clause there is logical expression. In <code>ORDER BY</code>,
<code>LIMIT</code> and almost any other component SQLite expression might occur. It's everywhere! After this realization I was
    convinced that I have to start from implementing parsing <a href="https://www.sqlite.org/lang_expr.html">SQLite expression</a>. The
    picture on the top presents visual representation of <code>expr</code> grammar and it's not complete!
</p> <p>
As you can see even parsing just an expression is not a trivial task. There are few points that shall be taken into
    consideration before implementing this parser. That is - operators precedence order, recursive nature of an expression
    and complexity of possible cases. Nevertheless it should be implemented before anything else. As I expected it was a
    good decision. Everything after implementing and testing parsing an expression was rather joyful.
</p> <p>
That might be obvious but perhaps it's worth to mention how I represented SQLite expression in Scala. I think the
    natural way of expressing this kind of objects is through <a href="https://en.wikipedia.org/wiki/Algebraic_data_type">sum type</a>
using Scala traits and inheritance.
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="scala"><code><span class="line"><span style="color:#569CD6">sealed</span><span style="color:#569CD6"> trait</span><span style="color:#4EC9B0"> SqliteToken</span></span>
<span class="line"><span style="color:#569CD6">sealed</span><span style="color:#569CD6"> trait</span><span style="color:#4EC9B0"> SqliteExpr</span><span style="color:#569CD6"> extends</span><span style="color:#4EC9B0"> SqliteToken</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6">sealed</span><span style="color:#569CD6"> trait</span><span style="color:#4EC9B0"> SqliteLiteral</span><span style="color:#569CD6"> extends</span><span style="color:#4EC9B0"> SqliteExpr</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteIntegerLit</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">value</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">Int</span><span style="color:#D4D4D4">) </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteDoubleLit</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">value</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">Double</span><span style="color:#D4D4D4">) </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteHexLit</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">input</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">String</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">value</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">Int</span><span style="color:#D4D4D4">) </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteStringLit</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">value</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">String</span><span style="color:#D4D4D4">) </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteBlobLit</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">value</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">String</span><span style="color:#D4D4D4">) </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteNull</span><span style="color:#D4D4D4">() </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteTrue</span><span style="color:#D4D4D4">() </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteFalse</span><span style="color:#D4D4D4">() </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteCurrentTimestamp</span><span style="color:#D4D4D4">() </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteCurrentTime</span><span style="color:#D4D4D4">() </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteCurrentDate</span><span style="color:#D4D4D4">() </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteLiteralError</span><span style="color:#D4D4D4">() </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteLiteral</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteColumnExpr</span><span style="color:#D4D4D4">(</span></span>
<span class="line"><span style="color:#9CDCFE">  schemaName</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">Option</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">String</span><span style="color:#D4D4D4">] = </span><span style="color:#4EC9B0">None</span><span style="color:#D4D4D4">,</span></span>
<span class="line"><span style="color:#9CDCFE">  tableName</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">Option</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">String</span><span style="color:#D4D4D4">] = </span><span style="color:#4EC9B0">None</span><span style="color:#D4D4D4">,</span></span>
<span class="line"><span style="color:#9CDCFE">  columnName</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">String</span></span>
<span class="line"><span style="color:#D4D4D4">) </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteExpr</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteCaseExpr</span><span style="color:#D4D4D4">(</span></span>
<span class="line"><span style="color:#9CDCFE">  initalExpr</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">Option</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">SqliteExpr</span><span style="color:#D4D4D4">] = </span><span style="color:#4EC9B0">None</span><span style="color:#D4D4D4">,</span></span>
<span class="line"><span style="color:#9CDCFE">  whenThens</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">List</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">SqliteCaseWhenThen</span><span style="color:#D4D4D4">],</span></span>
<span class="line"><span style="color:#9CDCFE">  elseExpr</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">Option</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">SqliteExpr</span><span style="color:#D4D4D4">] = </span><span style="color:#4EC9B0">None</span></span>
<span class="line"><span style="color:#D4D4D4">) </span><span style="color:#569CD6">extends</span><span style="color:#4EC9B0"> SqliteExpr</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6">case</span><span style="color:#569CD6"> class</span><span style="color:#4EC9B0"> SqliteCaseWhenThen</span><span style="color:#D4D4D4">(</span><span style="color:#9CDCFE">when</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">SqliteExpr</span><span style="color:#D4D4D4">, </span><span style="color:#C586C0">then</span><span style="color:#D4D4D4">: </span><span style="color:#4EC9B0">SqliteExpr</span><span style="color:#D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A9955">// and so on ...</span></span></code></pre> <p>
For parsed <code>SqliteExpr</code> object we can pattern match onto concrete representation very easily in Scala.
</p> <h2 id="reflections" class="chapter" data-astro-cid-5d3zeytc> <a href="#reflections" data-astro-cid-5d3zeytc>Reflections</a> </h2>  <p>
My general reflection after implementing SQLite <code>SELECT</code> parser using fastparse is that, once you're familiar with this
    library writing parsers is almost as trivial as specifying just a grammar. The overhead is very low but advantages are
    great in my opinion. I could unit test each little step for each little parsers I've implemented. Lexing part, scanning text
    into tokens, is entirely omitted and the outcome representation in the parse tree might be a bit different (simpler)
    than grammar. In ANTLR it's not possible.
</p> <p>
I'm very far of being an expert of fastparse but as far as I know it's not very easy to customize parsing error
    messages. There are some functionalities to handle it better but for sure it's worse than in case of hand-written
    parser. Overall I'm very satisfied with the result.
</p> <h2 id="format-sql" class="chapter" data-astro-cid-5d3zeytc> <a href="#format-sql" data-astro-cid-5d3zeytc>Let&#39;s format SQL</a> </h2>  <p>
Ok, let's say I'm in the moment when I've implemented and fairly tested SQLite <code>SELECT</code> parser. What can I do with it?
    I had many ideas even before starting this side project. I've decided to implement formatting SQL queries based on
    parsed tree. Firstly it's visual appealing. Secondly it touches all nodes of the parse tree, so it's a good overall
    test.
</p> <p>
Back when I was working in PwC there was a period when I was writing mainly T-SQL daily. I was easily over a million
    lines of SQL in total over two or three years. After some time I started to format code in the way I thought was the
    most readable. And I stick to it. Even to this day I have this formatting in my muscle memory. So I knew exactly how I
    wanted to implement this SQL formatter. There is no need for configuration. I just want to implement my style. Just like
<a href="https://pkg.go.dev/cmd/gofmt">go fmt</a> does.
</p> <p>
For example let's take this made up query:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">with</span><span style="color:#D4D4D4"> tmp1 </span><span style="color:#569CD6">as</span><span style="color:#D4D4D4"> (</span><span style="color:#569CD6">select</span><span style="color:#D4D4D4"> a, b, a + b * </span><span style="color:#B5CEA8">13</span><span style="color:#569CD6"> as</span><span style="color:#D4D4D4"> c </span><span style="color:#569CD6">from</span><span style="color:#D4D4D4"> src.table1), tmp2 </span><span style="color:#569CD6">as</span><span style="color:#D4D4D4"> (</span><span style="color:#569CD6">select</span><span style="color:#D4D4D4"> * </span><span style="color:#569CD6">from</span><span style="color:#D4D4D4"> another.table2 </span><span style="color:#569CD6">where</span><span style="color:#D4D4D4"> x > </span><span style="color:#B5CEA8">42</span><span style="color:#D4D4D4">) </span><span style="color:#569CD6">select</span></span>
<span class="line"><span style="color:#D4D4D4">t1.a, t1.b, t1.c, t2.crap, x.X </span><span style="color:#569CD6">from</span><span style="color:#D4D4D4"> tmp1 t1 </span><span style="color:#569CD6">left join</span><span style="color:#D4D4D4"> tmp2 t2 </span><span style="color:#569CD6">on</span><span style="color:#D4D4D4"> t1.a > t2.crap </span><span style="color:#569CD6">inner join</span><span style="color:#D4D4D4"> ( </span><span style="color:#569CD6">select</span><span style="color:#D4D4D4"> col1, X </span><span style="color:#569CD6">from</span></span>
<span class="line"><span style="color:#D4D4D4">src.crap c </span><span style="color:#569CD6">inner join</span><span style="color:#D4D4D4"> dict.crap c2 </span><span style="color:#569CD6">on</span><span style="color:#D4D4D4"> c.col1 = c2.col1_dict) </span><span style="color:#569CD6">as</span><span style="color:#D4D4D4"> x </span><span style="color:#569CD6">on</span><span style="color:#D4D4D4"> t2.crap = x.col1 </span><span style="color:#569CD6">where</span><span style="color:#D4D4D4"> t1.a + x.X > -</span><span style="color:#B5CEA8">12</span><span style="color:#569CD6"> LIMIT</span><span style="color:#B5CEA8"> 10</span></span></code></pre> <p>
It's a single line, almost all lowercase and no indentation. My formatter turn this into the following:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#569CD6">WITH</span><span style="color:#D4D4D4"> tmp1 </span><span style="color:#569CD6">AS</span><span style="color:#D4D4D4"> (</span></span>
<span class="line"><span style="color:#569CD6">    SELECT</span></span>
<span class="line"><span style="color:#D4D4D4">        a,</span></span>
<span class="line"><span style="color:#D4D4D4">        b,</span></span>
<span class="line"><span style="color:#D4D4D4">        a + b * </span><span style="color:#B5CEA8">13</span><span style="color:#569CD6"> AS</span><span style="color:#D4D4D4"> c</span></span>
<span class="line"><span style="color:#569CD6">    FROM</span></span>
<span class="line"><span style="color:#D4D4D4">        src.table1</span></span>
<span class="line"><span style="color:#D4D4D4">),</span></span>
<span class="line"><span style="color:#D4D4D4">tmp2 </span><span style="color:#569CD6">AS</span><span style="color:#D4D4D4"> (</span></span>
<span class="line"><span style="color:#569CD6">    SELECT</span></span>
<span class="line"><span style="color:#D4D4D4">        *</span></span>
<span class="line"><span style="color:#569CD6">    FROM</span></span>
<span class="line"><span style="color:#D4D4D4">        another.table2</span></span>
<span class="line"><span style="color:#569CD6">    WHERE</span></span>
<span class="line"><span style="color:#D4D4D4">        x > </span><span style="color:#B5CEA8">42</span></span>
<span class="line"><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#569CD6">SELECT</span></span>
<span class="line"><span style="color:#D4D4D4">    t1.a,</span></span>
<span class="line"><span style="color:#D4D4D4">    t1.b,</span></span>
<span class="line"><span style="color:#D4D4D4">    t1.c,</span></span>
<span class="line"><span style="color:#D4D4D4">    t2.crap,</span></span>
<span class="line"><span style="color:#D4D4D4">    x.X</span></span>
<span class="line"><span style="color:#569CD6">FROM</span></span>
<span class="line"><span style="color:#D4D4D4">    tmp1 </span><span style="color:#569CD6">AS</span><span style="color:#D4D4D4"> t1</span></span>
<span class="line"><span style="color:#569CD6">LEFT JOIN</span></span>
<span class="line"><span style="color:#D4D4D4">    tmp2 </span><span style="color:#569CD6">AS</span><span style="color:#D4D4D4"> t2 </span><span style="color:#569CD6">ON</span><span style="color:#D4D4D4"> t1.a > t2.crap</span></span>
<span class="line"><span style="color:#569CD6">INNER JOIN</span></span>
<span class="line"><span style="color:#D4D4D4">    (</span></span>
<span class="line"><span style="color:#569CD6">        SELECT</span></span>
<span class="line"><span style="color:#D4D4D4">            col1,</span></span>
<span class="line"><span style="color:#D4D4D4">            X</span></span>
<span class="line"><span style="color:#569CD6">        FROM</span></span>
<span class="line"><span style="color:#D4D4D4">            src.crap </span><span style="color:#569CD6">AS</span><span style="color:#D4D4D4"> c</span></span>
<span class="line"><span style="color:#569CD6">        INNER JOIN</span></span>
<span class="line"><span style="color:#D4D4D4">            dict.crap </span><span style="color:#569CD6">AS</span><span style="color:#D4D4D4"> c2 </span><span style="color:#569CD6">ON</span><span style="color:#D4D4D4"> c.col1 = c2.col1_dict</span></span>
<span class="line"><span style="color:#D4D4D4">    ) </span><span style="color:#569CD6">AS</span><span style="color:#D4D4D4"> x </span><span style="color:#569CD6">ON</span><span style="color:#D4D4D4"> t2.crap = x.col1</span></span>
<span class="line"><span style="color:#569CD6">WHERE</span></span>
<span class="line"><span style="color:#D4D4D4">    t1.a + x.X > -</span><span style="color:#B5CEA8">12</span></span>
<span class="line"><span style="color:#569CD6">LIMIT</span></span>
<span class="line"><span style="color:#B5CEA8">    10</span></span></code></pre> <p>
As you can see the formatter work properly in case of recursion (sub-query). In this case it adds another level of
    indentation. All keywords and clauses are now uppercase. Indentation is consistent. Once you have a parse tree
    implementing this formatter was done in single evening. It was straightforward.
</p> <h2 id="summary" class="chapter" data-astro-cid-5d3zeytc> <a href="#summary" data-astro-cid-5d3zeytc>Summary</a> </h2>  <p>
Overall that was a very good experience. I'm very happy about it. I'm glad that I found fastparse library. Without this
    library I probably wouldn't decide to implement hand-written SQL parser on the side. Development process was very swift.
    I'm a bit concerned about parsing error handling. And because of that I'm not yet sure if I would use this library to
    implement production ready and complex parser. In the case when parser would be the foundation to another tools I'd
    probably go with hand-written version. But even in this case I think I'd try to use parser combinators approach to do
    so.
</p> <p> <strong>PS.</strong> I haven't implemented full SQLite parser. Just <code>SELECT</code>, but that should cover most common queries.
</p> <p> <strong>PS2.</strong> This parser is not yet open sourced. If that happen I'll put link here.
</p> <h2 id="references" class="chapter" data-astro-cid-5d3zeytc> <a href="#references" data-astro-cid-5d3zeytc>References</a> </h2>  <ol> <li><a href="https://github.com/com-lihaoyi/fastparse">fastparse</a></li> <li><a href="https://com-lihaoyi.github.io/fastparse/">fastparse docs</a></li> <li><a href="https://en.wikipedia.org/wiki/Parser_combinator">parser combinators</a></li> </ol>  </article> </main> </div> </div>  <!-- Global styles for .post-layout and .post-layout-sidebar -->  </body></html>