<!DOCTYPE html><html lang="en" data-astro-cid-gvpn4u4b> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Be Cautious When Using time.Time as Keys in Go Maps</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.26/dist/katex.min.css" crossorigin="anonymous"><style>*,*:before,*:after{box-sizing:border-box}html,body{max-width:100%;overflow-x:hidden}html{-webkit-text-size-adjust:100%}:root{--bg-color: #111010;--text-primary: #ffe9c6;--text-secondary: #2AA198;--accent-color: #f97d43;--font-body: "Roboto", sans-serif;--font-code: "JetBrains Mono", monospace}html{font-size:19px}@media (max-width: 480px){html{font-size:16px}}@media (max-width: 360px){html{font-size:15px}}body{font-size:1rem;line-height:1.66;background-color:var(--bg-color);color:var(--text-primary);font-family:var(--font-body);margin:0;padding:0;word-wrap:break-word;overflow-wrap:break-word}h1{font-size:2.25rem;line-height:1.2}h2{font-size:1.75rem;line-height:1.3}h3{font-size:1.35rem;line-height:1.35}@media (max-width: 768px){h1{font-size:2rem}h2{font-size:1.5rem}h3{font-size:1.2rem}}@media (max-width: 480px){h1{font-size:1.75rem}h2{font-size:1.35rem}h3{font-size:1.1rem}}@media (max-width: 360px){h1{font-size:1.6rem}h2{font-size:1.25rem}h3{font-size:1.05rem}}a{color:var(--text-secondary);text-decoration:none}a:hover{text-decoration:underline}pre{background-color:#1e1e1e;border-radius:8px;padding:1rem;overflow-x:auto;margin:1rem 0;font-size:15px;font-family:var(--font-code)}code{background-color:transparent}pre>code{display:block}.toc ul{list-style:none;margin:0;padding:0}.toc li{margin:.5rem 0}.toc a{color:var(--text-secondary);text-decoration:none}.toc a:hover{text-decoration:underline}.toc a.active{font-weight:700;color:var(--accent-color)}nav[data-astro-cid-dmqpwcec]{padding:1rem 0;text-align:center}ul[data-astro-cid-dmqpwcec]{list-style:none;padding:0;margin:0;display:flex;justify-content:center;gap:1.5rem;flex-wrap:wrap}@media (max-width: 480px){ul[data-astro-cid-dmqpwcec]{gap:1rem}a[data-astro-cid-dmqpwcec]{font-size:1rem;padding:.4rem .8rem}}@media (max-width: 360px){ul[data-astro-cid-dmqpwcec]{gap:.5rem}a[data-astro-cid-dmqpwcec]{font-size:.9rem;padding:.3rem .6rem}}li[data-astro-cid-dmqpwcec]{display:inline}a[data-astro-cid-dmqpwcec]{color:var(--text-primary);font-size:1.2rem;padding:.5rem 1rem;border:1px solid transparent;transition:all .3s ease-in-out}a[data-astro-cid-dmqpwcec]:hover{border:1px solid var(--accent-color);border-radius:4px;color:var(--accent-color)}.active[data-astro-cid-dmqpwcec] a[data-astro-cid-dmqpwcec]{color:var(--accent-color);font-weight:700;border-bottom:2px solid var(--accent-color)}hr[data-astro-cid-dmqpwcec]{margin-top:1rem;border:none;height:2px;background:var(--text-secondary);width:90%;max-width:800px;margin-left:auto;margin-right:auto}
.post-title[data-astro-cid-resui2ln]{margin-bottom:2rem}.post-title[data-astro-cid-resui2ln] h1[data-astro-cid-resui2ln]{font-size:1.75rem;color:var(--accent-color);margin:0}.post-date[data-astro-cid-resui2ln]{font-size:1rem;color:var(--text-secondary);margin-top:.5rem}.publish-label[data-astro-cid-resui2ln]{font-weight:700;color:var(--text-primary)}
.chapter[data-astro-cid-5d3zeytc]{font-size:2rem;margin-top:2rem;color:var(--accent-color)}.chapter[data-astro-cid-5d3zeytc] a[data-astro-cid-5d3zeytc]{color:var(--accent-color);text-decoration:none}.chapter[data-astro-cid-5d3zeytc] a[data-astro-cid-5d3zeytc]:hover{text-decoration:underline}
.post-layout{display:flex;flex-direction:row}@media (min-width: 1024px){.post-layout{flex-direction:row}.post-layout-sidebar{position:fixed;left:2rem;top:10rem;width:200px;font-size:.85rem;padding:1rem;z-index:10}.post-layout-content{flex:1;max-width:1000px;margin:0 auto;padding-left:240px;padding-right:2rem}}@media (min-width: 1400px){.post-layout-content{max-width:1200px}}.post-layout-sidebar{display:none}@media (min-width: 1024px){.post-layout-sidebar{display:block}}@media (max-width: 1023px){.post-layout{flex-direction:column}.post-layout-content{width:100%;max-width:100%}}:global(pre){width:100%!important;max-width:100%!important;overflow-x:auto;box-sizing:border-box}:global(.astro-code){width:100%!important;max-width:100%!important;box-sizing:border-box}:global(.astro-code pre){width:100%!important;max-width:100%!important;overflow-x:auto;box-sizing:border-box}:global(.post-layout-content pre){max-width:100%!important;overflow-x:auto;word-wrap:break-word;white-space:pre-wrap}main[data-astro-cid-gvpn4u4b]{padding:2rem 1rem;max-width:900px;margin:0 auto;width:100%;box-sizing:border-box}@media (min-width: 1024px){main[data-astro-cid-gvpn4u4b]{padding:2rem 0;max-width:none}}@media (max-width: 768px){main[data-astro-cid-gvpn4u4b]{padding:1.5rem .75rem}}@media (max-width: 480px){main[data-astro-cid-gvpn4u4b]{padding:1rem .5rem}}article[data-astro-cid-gvpn4u4b]{max-width:800px;width:100%;margin:0 auto;color:var(--text-primary);box-sizing:border-box;word-wrap:break-word;overflow-wrap:break-word}h1[data-astro-cid-gvpn4u4b],h2[data-astro-cid-gvpn4u4b],h3[data-astro-cid-gvpn4u4b]{color:var(--accent-color);margin-top:1.5rem;word-wrap:break-word;overflow-wrap:break-word}p[data-astro-cid-gvpn4u4b]{color:var(--text-secondary);word-wrap:break-word;overflow-wrap:break-word;hyphens:auto}img[data-astro-cid-gvpn4u4b]{max-width:100%;max-height:400px;width:auto;height:auto;border-radius:8px;margin:1rem 0;object-fit:contain}@media (max-width: 768px){img[data-astro-cid-gvpn4u4b]{max-height:300px}}@media (max-width: 480px){img[data-astro-cid-gvpn4u4b]{max-height:250px}}blockquote[data-astro-cid-gvpn4u4b]{border-left:4px solid var(--accent-color);padding-left:1rem;color:var(--text-primary);font-style:italic;margin:1rem 0}code[data-astro-cid-gvpn4u4b]{font-family:monospace;background:#ffffff1a;padding:.2rem .4rem;border-radius:4px;font-size:.95rem}
</style></head> <body data-astro-cid-gvpn4u4b> <header data-astro-cid-gvpn4u4b> <nav data-astro-cid-dmqpwcec> <ul data-astro-cid-dmqpwcec> <li class data-astro-cid-dmqpwcec> <a href="/" data-astro-cid-dmqpwcec>Posts</a> </li><li class data-astro-cid-dmqpwcec> <a href="/about" data-astro-cid-dmqpwcec>About</a> </li><li class data-astro-cid-dmqpwcec> <a href="/resume.html" data-astro-cid-dmqpwcec>Resume</a> </li> </ul> </nav>  </header> <!-- 
      1) Wrap sidebar + main in a single parent .post-layout
         so flexbox can place them side by side on large screens 
    --> <div class="post-layout" data-astro-cid-gvpn4u4b> <!-- SIDEBAR --> <aside class="post-layout-sidebar" data-astro-cid-gvpn4u4b> <!-- The nav container that will hold our generated TOC --><nav id="table-of-contents" class="toc"></nav> <script client:load>
  window.addEventListener('DOMContentLoaded', () => {
    buildTOC();
    highlightActiveHeading();
  });

  // 1. Build the TOC once the page is loaded
  function buildTOC() {
    const chapterHeadings = Array.from(document.querySelectorAll('h2.chapter[id]'));
    const tocContainer = document.getElementById('table-of-contents');
    if (!tocContainer) return;

    const ul = document.createElement('ul');

    chapterHeadings.forEach((heading) => {
      const li = document.createElement('li');
      const a = document.createElement('a');

      // The heading has an `id` like "intro" or "symptoms"
      a.href = `#${heading.id}`;

      a.textContent = heading.textContent.trim();

      li.appendChild(a);
      ul.appendChild(li);
    });

    tocContainer.appendChild(ul);
  }

    function highlightActiveHeading() {
      const links = Array.from(document.querySelectorAll('#table-of-contents a'));
      const headingEls = links.map((link) => document.getElementById(link.hash.slice(1)));

      // 3. Create the observer
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            console.log(
              `Heading: ${entry.target.id}, isIntersecting: ${entry.isIntersecting}`
            );
            if (entry.isIntersecting) {
              // Remove 'active' from all links
              links.forEach((l) => l.classList.remove('active'));

              // Highlight the link for the heading that just entered
              const activeLink = links.find(
                (l) => l.hash === `#${entry.target.id}`
              );
              if (activeLink) {
                activeLink.classList.add('active');
              }
            }
          });
        },
        {
          root: null,
          rootMargin: '-15% 0px -60% 0px',
          threshold: 0,
        }
      );

      // 4. Observe each heading
      headingEls.forEach((el) => {
        if (el) {
          console.log(`Observing heading: ${el.id}`);
          observer.observe(el);
        }
      });
    }
</script> </aside> <!-- MAIN CONTENT AREA --> <div class="post-layout-content" data-astro-cid-gvpn4u4b> <main data-astro-cid-gvpn4u4b> <article data-astro-cid-gvpn4u4b>  <div class="post-title" data-astro-cid-resui2ln> <h1 data-astro-cid-resui2ln>Be Cautious When Using time.Time as Keys in Go Maps</h1> <p class="post-date" data-astro-cid-resui2ln> <span class="publish-label" data-astro-cid-resui2ln>Publish date:</span> 2024-08-13 </p> </div>  <h2 id="intro" class="chapter" data-astro-cid-5d3zeytc> <a href="#intro" data-astro-cid-5d3zeytc>Intro</a> </h2>  <p>
Recently, I encountered a strange bug in <a href="https://ppacer.org">ppacer</a>. The
    scheduler had a bug that only appeared on Linux, which was particularly
    concerning since it directly affected ppacer's core functionality: scheduling.
</p> <p>
Before we dive into the details, I want to mention that throughout the
    development of ppacer, I rarely encountered issues that took more than a few
    minutes to debug. However, this particular bug took me 4-5 hours to track down.
    That’s why I thought that this behavior might not be obvious to others as well.
    So, I’d like to share what I’ve learned.
</p> <p>
I'll try to focus on the bug and solution in abstraction, without getting into
    details of ppacer internal types and logic.
</p> <h2 id="symptoms" class="chapter" data-astro-cid-5d3zeytc> <a href="#symptoms" data-astro-cid-5d3zeytc>Symptoms</a> </h2>  <p>
Using ppacer, I wanted to schedule and execute a process which, after the first
    task, had another two concurrent tasks to be scheduled. The first task was
    scheduled and executed successfully, but then its children never got scheduled.
    No errors, nothing. They simply wouldn't schedule.
</p> <p>
This issue occurred on a relatively modest EC2 instance (2GB RAM, 2 vCPU) running Linux.
    Strangely, the exact same program ran perfectly on Windows and macOS (MacBook Air M1).
    That was puzzling. For context, ppacer is built with Go 1.22, and its only dependency
    is a driver for SQLite.
</p> <h2 id="debugging" class="chapter" data-astro-cid-5d3zeytc> <a href="#debugging" data-astro-cid-5d3zeytc>Debugging</a> </h2>  <p>
Initially, I thought the issue might be due to the limited resources on the EC2 instance.
    However, ppacer generally doesn’t consume much in terms of resources, and the particular
    example in question was relatively simple, so that didn’t seem to be the case.
</p> <p>
After enabling `DEBUG` level logging, I discovered that child tasks weren’t getting scheduled
    because the parent task’s status in the cache was <code>SCHEDULED</code> rather than <code>SUCCESS</code>.
</p> <p>
I couldn’t figure out how this was possible. The logs clearly showed that the correct <code>SUCCESS</code>
status was stored in the cache, but when another goroutine retrieved the value from the cache for
    the same key, it returned <code>SCHEDULED</code> instead. That made no sense!
</p> <p>
Looking deeper into the cache itself, I noticed two identical-looking keys with different values.
    This pointed me towards an issue with using <code>time.Time</code> as map keys.
</p> <h2 id="time-time-map-keys" class="chapter" data-astro-cid-5d3zeytc> <a href="#time-time-map-keys" data-astro-cid-5d3zeytc>time.Time in Go map keys</a> </h2>  <p>
The root cause of the issue is that <code>time.Time</code> contains both a "wall clock" time and
    a monotonic clock value. While two <code>time.Time</code> values might look identical when printed,
    they can have different monotonic clock values, causing them to be treated as distinct keys in a map.
</p> <p>
Additionally, monotonic clock values are system-dependent, and they are not preserved when
<code>time.Time</code> is serialized. This explains why the bug only appeared when running on Linux.
</p> <h2 id="reproducible-example" class="chapter" data-astro-cid-5d3zeytc> <a href="#reproducible-example" data-astro-cid-5d3zeytc>Reproducible example</a> </h2>  <p>
Consider the following simple Go program:
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#569CD6">package</span><span style="color:#4EC9B0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0">import</span><span style="color:#D4D4D4"> (</span></span>
<span class="line"><span style="color:#CE9178">    "fmt"</span></span>
<span class="line"><span style="color:#CE9178">    "time"</span></span>
<span class="line"><span style="color:#D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6">type</span><span style="color:#4EC9B0"> Key</span><span style="color:#569CD6"> struct</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">    Name</span><span style="color:#4EC9B0">      string</span></span>
<span class="line"><span style="color:#9CDCFE">    Timestamp</span><span style="color:#4EC9B0"> time</span><span style="color:#D4D4D4">.</span><span style="color:#4EC9B0">Time</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#569CD6">func</span><span style="color:#DCDCAA"> main</span><span style="color:#D4D4D4">() {</span></span>
<span class="line"><span style="color:#9CDCFE">    cache</span><span style="color:#D4D4D4"> := </span><span style="color:#DCDCAA">make</span><span style="color:#D4D4D4">(</span><span style="color:#569CD6">map</span><span style="color:#D4D4D4">[</span><span style="color:#4EC9B0">Key</span><span style="color:#D4D4D4">]</span><span style="color:#4EC9B0">int</span><span style="color:#D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9CDCFE">    now</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">time</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Date</span><span style="color:#D4D4D4">(</span><span style="color:#B5CEA8">2024</span><span style="color:#D4D4D4">, </span><span style="color:#B5CEA8">8</span><span style="color:#D4D4D4">, </span><span style="color:#B5CEA8">12</span><span style="color:#D4D4D4">, </span><span style="color:#B5CEA8">16</span><span style="color:#D4D4D4">, </span><span style="color:#B5CEA8">5</span><span style="color:#D4D4D4">, </span><span style="color:#B5CEA8">0</span><span style="color:#D4D4D4">, </span><span style="color:#B5CEA8">0</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">time</span><span style="color:#D4D4D4">.</span><span style="color:#9CDCFE">Local</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#9CDCFE">    k1</span><span style="color:#D4D4D4"> := </span><span style="color:#4EC9B0">Key</span><span style="color:#D4D4D4">{</span><span style="color:#9CDCFE">Name</span><span style="color:#D4D4D4">: </span><span style="color:#CE9178">"Damian"</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">Timestamp</span><span style="color:#D4D4D4">: </span><span style="color:#9CDCFE">now</span><span style="color:#D4D4D4">}</span></span>
<span class="line"><span style="color:#9CDCFE">    cache</span><span style="color:#D4D4D4">[</span><span style="color:#9CDCFE">k1</span><span style="color:#D4D4D4">] = </span><span style="color:#B5CEA8">42</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9CDCFE">    nowStr</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">now</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Format</span><span style="color:#D4D4D4">(</span><span style="color:#CE9178">"2006-01-02T15:04:05.999999MST-07:00"</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#9CDCFE">    now2</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">_</span><span style="color:#D4D4D4"> := </span><span style="color:#9CDCFE">time</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Parse</span><span style="color:#D4D4D4">(</span><span style="color:#CE9178">"2006-01-02T15:04:05.999999MST-07:00"</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">nowStr</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#9CDCFE">    k2</span><span style="color:#D4D4D4"> := </span><span style="color:#4EC9B0">Key</span><span style="color:#D4D4D4">{</span><span style="color:#9CDCFE">Name</span><span style="color:#D4D4D4">: </span><span style="color:#CE9178">"Damian"</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">Timestamp</span><span style="color:#D4D4D4">: </span><span style="color:#9CDCFE">now2</span><span style="color:#D4D4D4">}</span></span>
<span class="line"><span style="color:#9CDCFE">    cache</span><span style="color:#D4D4D4">[</span><span style="color:#9CDCFE">k2</span><span style="color:#D4D4D4">] = -</span><span style="color:#B5CEA8">123</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C586C0">    for</span><span style="color:#9CDCFE"> k</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">v</span><span style="color:#D4D4D4"> := </span><span style="color:#C586C0">range</span><span style="color:#9CDCFE"> cache</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">        fmt</span><span style="color:#D4D4D4">.</span><span style="color:#DCDCAA">Printf</span><span style="color:#D4D4D4">(</span><span style="color:#CE9178">"  -</span><span style="color:#9CDCFE">%v</span><span style="color:#CE9178">: </span><span style="color:#9CDCFE">%d</span></span>
<span class="line"><span style="color:#CE9178">"</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">k</span><span style="color:#D4D4D4">, </span><span style="color:#9CDCFE">v</span><span style="color:#D4D4D4">)</span></span>
<span class="line"><span style="color:#D4D4D4">    }</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <p>
Running this on macOS outputs:
</p> <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>  -{Damian 2024-08-12 16:05:00 +0200 CEST}: -123</span></span></code></pre> <p>
But on Debian, it outputs:
</p> <pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>  -{Damian 2024-08-12 16:05:00 +0000 UTC}: 42</span></span>
<span class="line"><span>  -{Damian 2024-08-12 16:05:00 +0000 UTC}: -123</span></span></code></pre> <p>
The two entries look the same but are different due to the hidden monotonic clock values.
</p> <h2 id="solution" class="chapter" data-astro-cid-5d3zeytc> <a href="#solution" data-astro-cid-5d3zeytc>Solution</a> </h2>  <p>
The fix was straightforward: use a serialized timestamp string instead of <code>time.Time</code> in cache keys.
</p> <pre class="astro-code dark-plus" style="background-color:#1E1E1E;color:#D4D4D4; overflow-x: auto;" tabindex="0" data-language="go"><code><span class="line"><span style="color:#569CD6">type</span><span style="color:#4EC9B0"> DRTBase</span><span style="color:#569CD6"> struct</span><span style="color:#D4D4D4"> {</span></span>
<span class="line"><span style="color:#9CDCFE">    DagId</span><span style="color:#4EC9B0">  string</span></span>
<span class="line"><span style="color:#9CDCFE">    AtTime</span><span style="color:#4EC9B0"> string</span><span style="color:#6A9955"> // Changed from time.Time</span></span>
<span class="line"><span style="color:#9CDCFE">    TaskId</span><span style="color:#4EC9B0"> string</span></span>
<span class="line"><span style="color:#D4D4D4">}</span></span></code></pre> <h2 id="summary" class="chapter" data-astro-cid-5d3zeytc> <a href="#summary" data-astro-cid-5d3zeytc>Summary</a> </h2>  <p>
Be cautious when using <code>time.Time</code> as keys in Go maps. While it can be useful, always
    be aware of the monotonic clock values and how they might impact key uniqueness.
</p> <p>
For more details, check out the official Go documentation on
<a href="https://pkg.go.dev/time#hdr-Monotonic_Clocks">monotonic clocks</a>.
</p>  </article> </main> </div> </div>  <!-- Global styles for .post-layout and .post-layout-sidebar -->  </body></html>