<!DOCTYPE html><html lang="en" data-astro-cid-gvpn4u4b> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>A year in Allegro Pay</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.26/dist/katex.min.css" crossorigin="anonymous"><style>*,*:before,*:after{box-sizing:border-box}html,body{max-width:100%;overflow-x:hidden}html{-webkit-text-size-adjust:100%}:root{--bg-color: #111010;--text-primary: #ffe9c6;--text-secondary: #2AA198;--accent-color: #f97d43;--font-body: "Roboto", sans-serif;--font-code: "JetBrains Mono", monospace}html{font-size:19px}@media (max-width: 480px){html{font-size:16px}}@media (max-width: 360px){html{font-size:15px}}body{font-size:1rem;line-height:1.66;background-color:var(--bg-color);color:var(--text-primary);font-family:var(--font-body);margin:0;padding:0;word-wrap:break-word;overflow-wrap:break-word}h1{font-size:2.25rem;line-height:1.2}h2{font-size:1.75rem;line-height:1.3}h3{font-size:1.35rem;line-height:1.35}@media (max-width: 768px){h1{font-size:2rem}h2{font-size:1.5rem}h3{font-size:1.2rem}}@media (max-width: 480px){h1{font-size:1.75rem}h2{font-size:1.35rem}h3{font-size:1.1rem}}@media (max-width: 360px){h1{font-size:1.6rem}h2{font-size:1.25rem}h3{font-size:1.05rem}}a{color:var(--text-secondary);text-decoration:none}a:hover{text-decoration:underline}pre{background-color:#1e1e1e;border-radius:8px;padding:1rem;overflow-x:auto;margin:1rem 0;font-size:15px;font-family:var(--font-code)}code{background-color:transparent}pre>code{display:block}.toc ul{list-style:none;margin:0;padding:0}.toc li{margin:.5rem 0}.toc a{color:var(--text-secondary);text-decoration:none}.toc a:hover{text-decoration:underline}.toc a.active{font-weight:700;color:var(--accent-color)}nav[data-astro-cid-dmqpwcec]{padding:1rem 0;text-align:center}ul[data-astro-cid-dmqpwcec]{list-style:none;padding:0;margin:0;display:flex;justify-content:center;gap:1.5rem;flex-wrap:wrap}@media (max-width: 480px){ul[data-astro-cid-dmqpwcec]{gap:1rem}a[data-astro-cid-dmqpwcec]{font-size:1rem;padding:.4rem .8rem}}@media (max-width: 360px){ul[data-astro-cid-dmqpwcec]{gap:.5rem}a[data-astro-cid-dmqpwcec]{font-size:.9rem;padding:.3rem .6rem}}li[data-astro-cid-dmqpwcec]{display:inline}a[data-astro-cid-dmqpwcec]{color:var(--text-primary);font-size:1.2rem;padding:.5rem 1rem;border:1px solid transparent;transition:all .3s ease-in-out}a[data-astro-cid-dmqpwcec]:hover{border:1px solid var(--accent-color);border-radius:4px;color:var(--accent-color)}.active[data-astro-cid-dmqpwcec] a[data-astro-cid-dmqpwcec]{color:var(--accent-color);font-weight:700;border-bottom:2px solid var(--accent-color)}hr[data-astro-cid-dmqpwcec]{margin-top:1rem;border:none;height:2px;background:var(--text-secondary);width:90%;max-width:800px;margin-left:auto;margin-right:auto}
.post-title[data-astro-cid-resui2ln]{margin-bottom:2rem}.post-title[data-astro-cid-resui2ln] h1[data-astro-cid-resui2ln]{font-size:1.75rem;color:var(--accent-color);margin:0}.post-date[data-astro-cid-resui2ln]{font-size:1rem;color:var(--text-secondary);margin-top:.5rem}.publish-label[data-astro-cid-resui2ln]{font-weight:700;color:var(--text-primary)}
.chapter[data-astro-cid-5d3zeytc]{font-size:2rem;margin-top:2rem;color:var(--accent-color)}.chapter[data-astro-cid-5d3zeytc] a[data-astro-cid-5d3zeytc]{color:var(--accent-color);text-decoration:none}.chapter[data-astro-cid-5d3zeytc] a[data-astro-cid-5d3zeytc]:hover{text-decoration:underline}
.post-layout{display:flex;flex-direction:row}@media (min-width: 1024px){.post-layout{flex-direction:row}.post-layout-sidebar{position:fixed;left:2rem;top:10rem;width:200px;font-size:.85rem;padding:1rem;z-index:10}.post-layout-content{flex:1;max-width:1000px;margin:0 auto;padding-left:240px;padding-right:2rem}}@media (min-width: 1400px){.post-layout-content{max-width:1200px}}.post-layout-sidebar{display:none}@media (min-width: 1024px){.post-layout-sidebar{display:block}}@media (max-width: 1023px){.post-layout{flex-direction:column}.post-layout-content{width:100%;max-width:100%}}:global(pre){width:100%!important;max-width:100%!important;overflow-x:auto;box-sizing:border-box}:global(.astro-code){width:100%!important;max-width:100%!important;box-sizing:border-box}:global(.astro-code pre){width:100%!important;max-width:100%!important;overflow-x:auto;box-sizing:border-box}:global(.post-layout-content pre){max-width:100%!important;overflow-x:auto;word-wrap:break-word;white-space:pre-wrap}main[data-astro-cid-gvpn4u4b]{padding:2rem 1rem;max-width:900px;margin:0 auto;width:100%;box-sizing:border-box}@media (min-width: 1024px){main[data-astro-cid-gvpn4u4b]{padding:2rem 0;max-width:none}}@media (max-width: 768px){main[data-astro-cid-gvpn4u4b]{padding:1.5rem .75rem}}@media (max-width: 480px){main[data-astro-cid-gvpn4u4b]{padding:1rem .5rem}}article[data-astro-cid-gvpn4u4b]{max-width:800px;width:100%;margin:0 auto;color:var(--text-primary);box-sizing:border-box;word-wrap:break-word;overflow-wrap:break-word}h1[data-astro-cid-gvpn4u4b],h2[data-astro-cid-gvpn4u4b],h3[data-astro-cid-gvpn4u4b]{color:var(--accent-color);margin-top:1.5rem;word-wrap:break-word;overflow-wrap:break-word}p[data-astro-cid-gvpn4u4b]{color:var(--text-secondary);word-wrap:break-word;overflow-wrap:break-word;hyphens:auto}img[data-astro-cid-gvpn4u4b]{max-width:100%;max-height:400px;width:auto;height:auto;border-radius:8px;margin:1rem 0;object-fit:contain}@media (max-width: 768px){img[data-astro-cid-gvpn4u4b]{max-height:300px}}@media (max-width: 480px){img[data-astro-cid-gvpn4u4b]{max-height:250px}}blockquote[data-astro-cid-gvpn4u4b]{border-left:4px solid var(--accent-color);padding-left:1rem;color:var(--text-primary);font-style:italic;margin:1rem 0}code[data-astro-cid-gvpn4u4b]{font-family:monospace;background:#ffffff1a;padding:.2rem .4rem;border-radius:4px;font-size:.95rem}
.image-container[data-astro-cid-6kov3kig]{display:flex;flex-direction:column;align-items:center;margin:1.5rem 0}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{width:auto;height:auto;border-radius:8px;object-fit:contain;box-shadow:0 4px 8px #0000001a}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig].inverted{filter:invert(1)}.image-caption[data-astro-cid-6kov3kig]{margin-top:.5rem;font-size:.9rem;color:var(--text-secondary, #666);font-style:italic;text-align:center;max-width:600px}@media (max-width: 768px){.image-container[data-astro-cid-6kov3kig]{margin:1rem 0}.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{max-height:300px!important}}@media (max-width: 480px){.image-container[data-astro-cid-6kov3kig] img[data-astro-cid-6kov3kig]{max-height:250px!important}.image-caption[data-astro-cid-6kov3kig]{font-size:.8rem;padding:0 1rem}}
</style></head> <body data-astro-cid-gvpn4u4b> <header data-astro-cid-gvpn4u4b> <nav data-astro-cid-dmqpwcec> <ul data-astro-cid-dmqpwcec> <li class data-astro-cid-dmqpwcec> <a href="/" data-astro-cid-dmqpwcec>Posts</a> </li><li class data-astro-cid-dmqpwcec> <a href="/about" data-astro-cid-dmqpwcec>About</a> </li><li class data-astro-cid-dmqpwcec> <a href="/resume.html" data-astro-cid-dmqpwcec>Resume</a> </li> </ul> </nav>  </header> <!-- 
      1) Wrap sidebar + main in a single parent .post-layout
         so flexbox can place them side by side on large screens 
    --> <div class="post-layout" data-astro-cid-gvpn4u4b> <!-- SIDEBAR --> <aside class="post-layout-sidebar" data-astro-cid-gvpn4u4b> <!-- The nav container that will hold our generated TOC --><nav id="table-of-contents" class="toc"></nav> <script client:load>
  window.addEventListener('DOMContentLoaded', () => {
    buildTOC();
    highlightActiveHeading();
  });

  // 1. Build the TOC once the page is loaded
  function buildTOC() {
    const chapterHeadings = Array.from(document.querySelectorAll('h2.chapter[id]'));
    const tocContainer = document.getElementById('table-of-contents');
    if (!tocContainer) return;

    const ul = document.createElement('ul');

    chapterHeadings.forEach((heading) => {
      const li = document.createElement('li');
      const a = document.createElement('a');

      // The heading has an `id` like "intro" or "symptoms"
      a.href = `#${heading.id}`;

      a.textContent = heading.textContent.trim();

      li.appendChild(a);
      ul.appendChild(li);
    });

    tocContainer.appendChild(ul);
  }

    function highlightActiveHeading() {
      const links = Array.from(document.querySelectorAll('#table-of-contents a'));
      const headingEls = links.map((link) => document.getElementById(link.hash.slice(1)));

      // 3. Create the observer
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            console.log(
              `Heading: ${entry.target.id}, isIntersecting: ${entry.isIntersecting}`
            );
            if (entry.isIntersecting) {
              // Remove 'active' from all links
              links.forEach((l) => l.classList.remove('active'));

              // Highlight the link for the heading that just entered
              const activeLink = links.find(
                (l) => l.hash === `#${entry.target.id}`
              );
              if (activeLink) {
                activeLink.classList.add('active');
              }
            }
          });
        },
        {
          root: null,
          rootMargin: '-15% 0px -60% 0px',
          threshold: 0,
        }
      );

      // 4. Observe each heading
      headingEls.forEach((el) => {
        if (el) {
          console.log(`Observing heading: ${el.id}`);
          observer.observe(el);
        }
      });
    }
</script> </aside> <!-- MAIN CONTENT AREA --> <div class="post-layout-content" data-astro-cid-gvpn4u4b> <main data-astro-cid-gvpn4u4b> <article data-astro-cid-gvpn4u4b>  <div class="post-title" data-astro-cid-resui2ln> <h1 data-astro-cid-resui2ln>A year in Allegro Pay</h1> <p class="post-date" data-astro-cid-resui2ln> <span class="publish-label" data-astro-cid-resui2ln>Publish date:</span> 2022-09-10 </p> </div>  <div class="image-container" data-astro-cid-6kov3kig> <img src="/allegropay/allegropay_logo.jpg" alt="Allegro Pay logo" style="max-width: 100%; max-height: 400px;" class data-astro-cid-6kov3kig> <p class="image-caption" data-astro-cid-6kov3kig>Allegro Pay logo</p> </div>  <h2 id="intro" class="chapter" data-astro-cid-5d3zeytc> <a href="#intro" data-astro-cid-5d3zeytc>Intro</a> </h2>  <p>
In August 2021 <a href="https://dskrzypiec.dev/leaving-pwc">I left PwC</a> and joined
    Allegro Pay in role of senior data engineer. Allegro Pay is a fintech sub
    company of the biggest e-commerce in central Europe -
<a href="https://allegro.pl">Allegro</a>. I've worked there for a year and in this post I
    want to summarized my experiences.
</p> <h2 id="onboarding" class="chapter" data-astro-cid-5d3zeytc> <a href="#onboarding" data-astro-cid-5d3zeytc>Onboarding and first thoughts</a> </h2>  <p>
Onboarding process in Allegro took four (4) days! That was very smooth
    introduction without any hassle. There was presentations about company culture,
    history and so on. It was rather pleasant experience.
</p> <p>
In contrast to PwC, Allegro was a tech company from the beginning. One of example
    of the difference is that Allegro have crucial internal IT systems centralized.
    Like identity and access management. In PwC it was more dependent on a team and
    region. In Allegro it's centralized. If I needed some access I immediately know
    where should I make a request. The same remains true for all HR systems.
</p> <p>
In PwC we mainly have used email as communication medium. Internal communicator
    was used only for quick chats. History older than a day was deleted from
    communicator, so all important information was exchanged via email. In Allegro
    people use Slack. There are support and help channels for everything. It's very
    easy to browse through channels and find information or just ask. In PwC often
    I wouldn't know who should I ask, so usually things were flowing through my
    direct manager.
</p> <h2 id="new-technologies" class="chapter" data-astro-cid-5d3zeytc> <a href="#new-technologies" data-astro-cid-5d3zeytc>New technologies</a> </h2>  <p>
When I've joined Allegro Pay data engineering team mainly used the following
    technologies: Snowflake, Airflow and dbt in purely data layer and besides that
    C# microservices. The first three I've never used prior joining Allegro.
</p> <h3>Snowflake</h3> <p>
We've used <a href="https://www.snowflake.com">Snowflake</a> as our main source for all
    analytical data and even a bit more. From all new technologies that I learned
    at Allegro Snowflake was easiest for me. Basically it's a modern, distributed
    data [warehouse | lake | store] done right. In almost all aspects using
    Snowflake was pure joy. It's just works. Regarding compression, performance and
    general convenience it's just great.
</p> <h3>Apache Airflow</h3> <p> <a href="https://airflow.apache.org">Airflow</a> was our main orchestrator for data
    pipelines. In fall 2021 we started using Airflow on Google Cloud Platform in
    form of <a href="https://cloud.google.com/composer">Cloud Composer</a>. I even liked the
    main idea besides the design of Airflow but it has unbelievably poor
    performance. Even first version of Composer (on the Cloud!) didn't resolve
    those issues. I definitely wasn't a fan of this one. On the other hand Allegro
    also uses Airflow and we've got support regarding Composer from another team.
</p> <h3>dbt</h3> <p>
We've tried using <a href="https://www.getdbt.com">dbt</a> as an alternative solution to
    improve effectiveness of local development of Airflow DAGs. First POCs were
    successful, so we decided to use it in one of our processes. Basically we were
    developing data pipelines locally using dbt and later on we automatically
    generate Airflow DAG based on dbt models (also DAGs). So final product was
    still data pipeline in Airflow but development process doesn't require local
    Airflow instance and rather slow feedback loop.
</p> <h2 id="flashbacks" class="chapter" data-astro-cid-5d3zeytc> <a href="#flashbacks" data-astro-cid-5d3zeytc>Flashbacks from consulting</a> </h2>  <p>
In October 2021 <a href="https://www.bankier.pl/wiadomosc/Allegro-Pay-ma-umowe-sprzedazy-wierzytelnosci-z-Aion-Bankiem-saldo-niesplaconych-wierzytelnosci-moze-siegnac-2-mld-zl-8203280.html">Allegro Pay signed the
    deal</a>
with <a href="https://aion.eu">Aion Bank</a> for selling some exposures. In general
    Allegro Pay would get paid and Aion, as rather new bank, would get portfolio of
    exposures. This project was important for Allegro Pay because at the time
    Allegro was also <a href="https://about.allegro.eu/news-releases/news-release-details/allegro-acquire-mall-group-leading-e-commerce-platform-across">acquiring Mall
    Group</a>.
</p> <p>
So the project was very important, deadline was really tight (3-4 weeks) and I
    was responsible for designing and implementing a process for exposures (in
    tranches) evaluation. Based on this evaluation actual offers, in form of formal
    legal documents, were prepared and sent to Aion. Pressure was very real. Based
    on this evaluation Allegro Pay would received 100-200mln PLN (~$40mln USD) in
    single payment.
</p> <p>
Just three months after I've escaped consulting I got into a project almost
    exactly the same I would expected to happen only in consulting. Nevertheless my
    experience was very good fit and I knew that for Allegro this is very unusual
    project so I did it. It was the only period in my time in Allegro when I had to
    done overtime. It was very intense couple of weeks.
</p> <p>
At the end we pulled it off before the deadline. Including very tough
    constrains I think we did very solid job. There wasn't single major mistake
    both in technical and business aspects. That was a great success. I think that
    in a regular bank or even consulting the same project would take a least 3
    months for consulting and at least 10 months for a bank.
</p> <h2 id="amd2" class="chapter" data-astro-cid-5d3zeytc> <a href="#amd2" data-astro-cid-5d3zeytc>AMD_2</a> </h2>  <p>
Another rather big task in our roadmap was designing and implementing improved
    version of AMD - <code>Analytical Data Model</code> (acronym in Polish is AMD). Analytical
    model which gather and unify data for entities like "user", "purchase",
    "payment" and other related with usual e-commerce kind of things. The first
    version of those entities were implemented just after Allegro Pay was created -
    about a year before I've joined. That was needed to be implemented really fast
    in order to enable ML team to prepare features and models as soon as possible.
    So obviously there was some shortcuts to meet the deadlines.
</p> <p>
The main idea behind <code>AMD_2</code> was to improve all deficiencies of the initial
    version. In the following subchapters I'll try to describe the most interesting
    parts and decisions of designing and implementing this process.
</p> <h3>Depending only on operational events</h3> <p>
Allegro is biggest or one of the biggest Polish tech companies. Even before
    acquiring Mall Group Allegro had around 3000 employees. Most of them are
    technical people. The Allegro on itself produce large amount of data but also
    on top of that many teams of data analysts and data engineers produces many
    data entities in many data lakes and other sources. It was a good decision to
    use some of analytical entities from Allegro in Allegro Pay analytical model,
    because it saves us much work of getting know all corners of business aspects
    of this data. The main disadvantage of using some entity prepared by another
    team in large organization is being dependent on this team and their decisions.
    This team at some point in time might change structure or algorithm for this
    entity and in this case we would have put some work to handle it.
</p> <p>
In AMD_2 we've decided to be dependent only on operational events which are
    generated by actual backend (and frontend) microservices and sent onto
<a href="https://github.com/allegro/hermes">Hermes</a> which is Allegro's asynchronous
    message broker built on top of Kafka.
</p> <h3>Using dbt</h3> <p> <code>AMD_2</code> was our first actual project where we used <code>dbt</code>. In general it was
    very good experience. Local development was for sure much quicker than using
    Airflow. The second advantage was testing in <code>dbt</code>. Tests in <code>dbt</code> are defined
    as macros (templated SQLs) or regular SQL scripts which can be applied to any
    model (tabel) and its columns using schema configuration in <code>YAML</code>. Therefore
    it was very straightforward to prepare tests on each stage of transformation
    process. Beginning at testing source inputs through executing tests after each
    transformation and finishing at testing final entity results.
</p> <p>
Even though <code>dbt</code> is a very convenient tool in final form we wanted <code>AMD_2</code> to
    be accessible in our Composer (Apache Airflow in GCP). So one colleague from
    our team write <code>DBTOperator</code> for wrapping <code>dbt</code> commands into Airflow operator
    and used it to write translator from <code>dbt</code> DAGs into Airflow DAGs including
    testing and execution of actual transformations. This can be done based on <a href="https://docs.getdbt.com/reference/artifacts/manifest-json">dbt
    manifest file</a> which
    contains all of information regarding <code>dbt</code> DAGs and its metadata. As I
    remember it took only around ~250 lines of Python code to implement this
    translation.
</p> <p>
Finally we could develop new entities locally using only <code>dbt</code> and Snowflake
    but outside of local environment we've got Airflow DAG produced automatically.
</p> <h2 id="delivery-addresses" class="chapter" data-astro-cid-5d3zeytc> <a href="#delivery-addresses" data-astro-cid-5d3zeytc>Integrating delivery addresses</a> </h2>  <p>
One day it turned out that the source with the full history of delivery addresses
    is no longer available. There was still a service and a database with last few
    years of those data but not the full set. Why that happened is probably
    interesting from perspective on working in large organization with many teams
    and so on, but it's not important here.
</p> <p>
For Allegro Pay this was a major problem, because one of our most important
    processes was dependent on that data in full scope and not only last few years.
</p> <p>
It was my task to handle this integration of historical data into single place.
    This data was in few places - legacy Cassandra (v2.1) cluster on premise,
    MongoDB also on premise and in Snowflake and BigQuery on two separate clouds.
    Generally it sounds like a simple task. Just take a data from few places and
    put it together. Easier said then done. There was a couple of challenges. For
    instance dumping data from Cassandra and MongoDB. Data volume. Integrity of
    this data over the time. Sending gigabytes of data between clouds. Fixing and
    handling data formats and consistency. Most of those are regular data
    engineering tasks. But almost direct impact on the business, scope and
    complexity of this task was making it very rewarding and satisfying.
</p> <p>
Some part of this problem I've described in
<a href="https://dskrzypiec.dev/copying-data/">Copying data between distributed systems</a>.
</p> <h2 id="summary" class="chapter" data-astro-cid-5d3zeytc> <a href="#summary" data-astro-cid-5d3zeytc>Summary</a> </h2>  <p>
Allegro is definitely a great place to work! People are great, work and
    technologies are interesting. But at the same time the atmosphere is peaceful
    and a good work-life balance is encouraged. For me it was a great year for
    sure! I met very interesting and alike colleagues and also learned a lot.
</p>  </article> </main> </div> </div>  <!-- Global styles for .post-layout and .post-layout-sidebar -->  </body></html>